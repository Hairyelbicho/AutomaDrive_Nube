<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard T&eacute;cnico | AutomaDrive Pro</title>
    <link rel="icon" href="/static/ia-logo.png" type="image/png">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root {
            --primary: #4ade80;
            --bg: #0b0e14;
            --card: #161b22;
            --text: #e6edf3;
            --btn-bg: #21262d;
            --gold: #e3b341;
            --accent: #00f2ff;
        }
        body { background: var(--bg); color: var(--text); font-family: 'Inter', sans-serif; margin: 0; padding: 15px; display: flex; flex-direction: column; min-height: 100vh; }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 1px solid var(--btn-bg); padding-bottom: 10px; }
        .logo-admin { font-weight: 800; color: var(--primary); font-size: 1.5rem; display: flex; align-items: center; gap: 10px; }
        .nav-buttons { display: flex; gap: 10px; align-items: center; }
        .master-clock { background: #000; color: var(--primary); padding: 8px 15px; border-radius: 8px; border: 1px solid var(--primary); font-family: monospace; font-size: 1.2rem; }
        .main-layout { display: grid; grid-template-columns: 350px 1fr 280px; gap: 15px; flex: 1; }
        .btn-nav { background: var(--btn-bg); border: 1px solid #30363d; color: white; padding: 10px 15px; border-radius: 8px; cursor: pointer; font-weight: bold; display: flex; align-items: center; gap: 8px; }
        .search-widget, .camera-section, .ai-assistant, .ad-box, .internal-comm { background: var(--card); padding: 15px; border-radius: 12px; border: 1px solid #30363d; margin-bottom: 15px; }

        .video-box, .map-box { width: 100%; height: 260px; background: #000; border-radius: 12px; border: 1px solid #30363d; margin-bottom: 15px; overflow: hidden; }

        .hero-box {
            width: 100%; height: 260px; border-radius: 12px; border: 1px solid #30363d;
            margin-bottom: 15px; overflow: hidden; background: #000; position: relative;
        }
        .hero-box img { width: 100%; height: 100%; object-fit: cover; display:block; filter: saturate(1.05) contrast(1.05); }
        .hero-overlay { position:absolute; inset:0; background: linear-gradient(180deg, rgba(0,0,0,0.25), rgba(0,0,0,0.78)); pointer-events:none; }
        .hero-caption { position:absolute; left:12px; bottom:12px; right:12px; display:flex; align-items:flex-end; justify-content:space-between; gap:10px; pointer-events:none; }
        .hero-caption .t { font-weight:900; letter-spacing:0.3px; }
        .hero-caption .s { font-size:0.78rem; color:#94a3b8; }

        .brand-mini { width: 34px; height: 34px; border-radius: 10px; border: 1px solid #30363d; object-fit: cover; box-shadow: 0 0 0 2px rgba(0,242,255,0.10); }

        .modal { display: none; position: fixed; z-index: 9999; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); }
        .modal-content { background: var(--card); margin: 5% auto; padding: 25px; border-radius: 15px; width: 450px; border: 1px solid var(--primary); }
        
        .mini-btn { background: #0d1117; border: 1px solid #30363d; color: #fff; padding: 8px 10px; border-radius: 10px; cursor: pointer; font-weight: 800; font-size: 0.78rem; }
        .pill { display:inline-block; padding:4px 8px; border-radius: 999px; border: 1px solid #30363d; font-size:0.72rem; color:#94a3b8; }

        .lock-overlay{ position:fixed; inset:0; z-index:99999; background:rgba(0,0,0,0.92); display:none; align-items:center; justify-content:center; padding:16px; }
        .lock-card{ width:min(520px, 96vw); background: var(--card); border:1px solid #30363d; border-radius: 16px; padding:18px; }
        .pattern-grid{ display:grid; grid-template-columns: repeat(3, 1fr); gap:10px; user-select:none; touch-action:none; }
        .dot{ width:60px; height:60px; margin:auto; border-radius:999px; border:2px solid #30363d; display:flex; align-items:center; justify-content:center; position:relative; }
        .dot::after{ content:''; width:14px; height:14px; border-radius:999px; background:#1f2937; }
        .dot.active{ border-color: var(--accent); }
        .dot.active::after{ background: var(--accent); }

        .msg-list{ background:#0d1117; border:1px solid #30363d; border-radius:10px; padding:10px; max-height:220px; overflow:auto; font-size:0.82rem; }
        .msg-item{ padding:8px 0; border-bottom:1px dashed #30363d; }
        .role-pill{ display:inline-flex; align-items:center; gap:6px; padding:6px 10px; border-radius:999px; border:1px solid #30363d; font-size:0.75rem; color:#94a3b8; cursor:pointer; }
        .role-pill.active{ border-color: var(--primary); color: var(--primary); }
        
        button:focus, input:focus, textarea:focus { outline: 2px solid rgba(0,242,255,0.25); }
    </style>
</head>
<body>

    <div class="header">
        <div class="logo-admin">
            <img src="/static/ia-logo.png" style="width:30px;">
            <img class="brand-mini" src="/static/admin-mini.png" alt="AutomaDrive Pro mini">
            <div>
                <span>Automa</span>Drive Pro
                <small style="display:block; font-size: 0.4em; color: var(--gold);">PANEL DE CONTROL</small>
            </div>
        </div>
        <div class="nav-buttons">
            <button class="btn-nav" onclick="toggleActividad()"><i class="fas fa-history"></i> ACTIVIDAD</button>
            <button class="btn-nav" onclick="nuevaFicha()"><i class="fas fa-plus"></i> NUEVO INGRESO</button>
            <div class="master-clock" id="reloj-maestro">00:00:00</div>
        </div>
    </div>

    <div class="main-layout">
        <div class="left-col">
            <div class="search-widget" style="background:white; color:#333;">
                <div style="font-size:0.7em; font-weight:bold; margin-bottom:5px;">BUSCAR EXPEDIENTE</div>
                <div style="display:flex; border:2px solid #000; border-radius:8px; overflow:hidden;">
                    <div style="background:#003366; color:white; padding:10px; font-weight:bold;">E</div>
                    <input type="text" id="widget-search" placeholder="0000 BBB" style="margin:0; border:none; color:#000; background:#fff; text-transform:uppercase; font-weight:bold;">
                    <button onclick="buscarDesdeWidget()" style="background:#000; color:var(--primary); border:none; padding:10px; cursor:pointer;">GO</button>
                </div>
            </div>

            <div class="camera-section">
                <button class="btn-nav" style="width:100%; background: var(--primary); color: #000; justify-content:center;" onclick="document.getElementById('camera-input').click()">
                    <i class="fas fa-camera"></i> CAPTURAR AVER&Iacute;A
                </button>
                <input type="file" id="camera-input" accept="image/*" capture="environment" style="display:none">
            </div>

            <div class="ai-assistant">
                <div style="color:var(--primary); font-weight:bold; margin-bottom:10px;"><i class="fas fa-robot"></i> CONSULTA T&Eacute;CNICA</div>
                <div id="ai-chat-admin" style="height:110px; font-size:0.8rem; color:#4ade80; overflow-y:auto; margin-bottom:10px;">Listo...</div>
                <input type="text" id="ai-admin-input" placeholder="Pregunta algo..." style="margin:0;">
            </div>
        </div>

        <div class="center-col">
            <div class="hero-box">
                <img src="/static/admin-hero.png" alt="AutomaDrive Pro Hero">
                <div class="hero-overlay"></div>
                <div class="hero-caption">
                    <div>
                        <div class="t">AutomaDrive Pro</div>
                        <div class="s">Gestión + Diagnóstico + Evidencias</div>
                    </div>
                    <div class="badge"><i class="fas fa-bolt" style="color:var(--accent);"></i> PRO</div>
                </div>
            </div>

            <div class="map-box" style="background: var(--card); padding: 15px;">
                <div style="font-weight:900; color: var(--accent); margin-bottom:10px;">
                    <i class="fas fa-microchip"></i> IA OBD (C&oacute;digos DTC)
                </div>
                <div class="obd-row">
                    <input id="obd-code" type="text" placeholder="P0300" maxlength="10">
                    <button id="obd-btn" class="obd-btn" onclick="obdExplain()">Analizar</button>
                </div>
                <div id="obd-result" class="result-box" style="display:none;"></div>
            </div>
        </div>

        <div class="side-col">
            <div class="internal-comm" style="border-color: var(--primary);">
                <h4 style="color:var(--primary); margin-top:0;"><i class="fas fa-database"></i> DATOS TALLER</h4>
                <div style="display:flex; gap:8px;">
                    <button class="mini-btn" style="flex:1;" onclick="triggerImport()"><i class="fas fa-upload"></i> Importar</button>
                    <button class="mini-btn" style="flex:1;" onclick="triggerExport()"><i class="fas fa-download"></i> Exportar</button>
                </div>
                <input type="file" id="import-file" style="display:none;" accept=".csv">
            </div>

            <div class="internal-comm" style="border-color: var(--accent);">
                <h4 style="color:var(--accent); margin-top:0;"><i class="fas fa-message"></i> CHAT INTERNO</h4>
                <div style="display:flex; gap:8px; margin-bottom:10px;">
                    <span class="role-pill" id="role-taller" onclick="setMsgRole('taller')">Taller</span>
                    <span class="role-pill" id="role-oficina" onclick="setMsgRole('oficina')">Oficina</span>
                </div>
                <div id="msg-list" class="msg-list"></div>
                <div class="msg-tools" style="margin-top:10px; display:flex; gap:5px;">
                    <input id="msg-input" type="text" placeholder="Escribe..." style="margin:0; flex:1;">
                    <button class="mini-btn" onclick="msgSend()"><i class="fas fa-paper-plane"></i></button>
                </div>
            </div>
        </div>
    </div>

    <div id="lockOverlay" class="lock-overlay">
      <div class="lock-card">
        <h3 style="color:var(--primary);"><i class="fas fa-lock"></i> Acceso Protegido</h3>
        <input id="lockEmail" class="lock-input" type="email" placeholder="Email Propietario" style="width:100%; margin-bottom:10px;">
        <input id="lockPin" class="lock-input" type="password" placeholder="PIN" maxlength="8" style="width:100%; margin-bottom:10px;">
        <div class="pattern-wrap">
            <div id="patternGrid" class="pattern-grid">
                <div class="dot" data-dot="1"></div><div class="dot" data-dot="2"></div><div class="dot" data-dot="3"></div>
                <div class="dot" data-dot="4"></div><div class="dot" data-dot="5"></div><div class="dot" data-dot="6"></div>
                <div class="dot" data-dot="7"></div><div class="dot" data-dot="8"></div><div class="dot" data-dot="9"></div>
            </div>
        </div>
        <div style="display:flex; gap:10px; margin-top:15px;">
            <button class="btn-nav" style="background:var(--primary); color:black; flex:1;" onclick="unlockNow()">VALIDAR</button>
            <button class="btn-nav" style="flex:1;" onclick="hideLock()">CERRAR</button>
        </div>
      </div>
    </div>

    <script>
        const $ = (id) => document.getElementById(id);
        let __patternCurrent = [];
        let __patternIsDrawing = false;
        let __pendingAction = null;

        /* --- RELOJ --- */
        function startClock() {
            setInterval(() => {
                $('reloj-maestro').textContent = new Date().toLocaleTimeString('es-ES');
            }, 1000);
        }

        /* --- SEGURIDAD --- */
        async function sha256Hex(text){
            const enc = new TextEncoder().encode(text);
            const buf = await crypto.subtle.digest("SHA-256", enc);
            return [...new Uint8Array(buf)].map(b=>b.toString(16).padStart(2,"0")).join("");
        }

        function showLock(action) {
            __pendingAction = action;
            $('lockOverlay').style.display = "flex";
        }
        function hideLock() { $('lockOverlay').style.display = "none"; }

        async function unlockNow() {
            const email = $('lockEmail').value;
            const pin = $('lockPin').value;
            const pattern = __patternCurrent.join("");
            
            // Simulación de validación (en producción comparar con localStorage)
            if(email && pin && pattern) {
                localStorage.setItem("adp_customer_email_v1", email);
                hideLock();
                if(__pendingAction) __pendingAction();
            } else { alert("Completa todos los campos de seguridad."); }
        }

        /* --- DATOS (IMPORT/EXPORT) --- */
        function triggerImport() {
            showLock(() => { $('import-file').click(); });
        }

        $('import-file').onchange = async (e) => {
            const file = e.target.files[0];
            const formData = new FormData();
            formData.append('file', file);
            const res = await fetch('/data/import', { method: 'POST', body: formData });
            if(res.ok) alert("Importación Exitosa.");
        };

        async function triggerExport() {
            showLock(async () => {
                const res = await fetch('/data/export');
                if(res.ok) {
                    const blob = await res.blob();
                    const a = document.createElement('a');
                    a.href = window.URL.createObjectURL(blob);
                    a.download = "taller_backup.csv";
                    a.click();
                }
            });
        }

        /* --- CHAT --- */
        function setMsgRole(role) {
            localStorage.setItem("msg_role", role);
            document.querySelectorAll(".role-pill").forEach(p => p.classList.remove("active"));
            $(`role-${role}`).classList.add("active");
        }

        async function msgSend() {
            const text = $('msg-input').value;
            const from = localStorage.getItem("msg_role") || "taller";
            await fetch('/msg/send', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ from, text })
            });
            $('msg-input').value = "";
            msgFetch();
        }

        async function msgFetch() {
            const res = await fetch('/msg/inbox');
            const data = await res.json();
            $('msg-list').innerHTML = data.map(m => `
                <div class="msg-item">
                    <b>${m.from}:</b> ${m.text} <small style="color:#666">${m.ts}</small>
                </div>
            `).join("");
        }

        /* --- OBD --- */
        async function obdExplain() {
            const code = $('obd-code').value;
            const res = await fetch('/obd-ask', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ code })
            });
            const data = await res.json();
            $('obd-result').style.display = "block";
            $('obd-result').textContent = data.response;
        }

        /* --- PATTERN LOGIC --- */
        function initPattern() {
            const grid = $('patternGrid');
            grid.addEventListener("mousedown", () => { __patternIsDrawing = true; __patternCurrent = []; document.querySelectorAll(".dot").forEach(d => d.classList.remove("active")); });
            window.addEventListener("mouseup", () => __patternIsDrawing = false);
            grid.addEventListener("mouseover", (e) => {
                const dot = e.target.closest(".dot");
                if(dot && __patternIsDrawing && !__patternCurrent.includes(dot.dataset.dot)) {
                    __patternCurrent.push(dot.dataset.dot);
                    dot.classList.add("active");
                }
            });
        }

        document.addEventListener('DOMContentLoaded', () => {
            startClock();
            initPattern();
            setMsgRole('taller');
            setInterval(msgFetch, 4000);
        });
    </script>
</body>
</html>