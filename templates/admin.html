<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard T&eacute;cnico | AutomaDrive Pro</title>
    <link rel="icon" href="/static/ia-logo.png" type="image/png">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sip.js/0.21.2/sip.min.js"></script>
    <style>
        /* --- OPTIMIZACIÓN UI / LAYOUT COMPACTO (OVERRIDE) --- */
        :root {
            --sp-safe: 12px;
            --radius-safe: 8px;
        }

        *,
        *:before,
        *:after {
            box-sizing: border-box !important;
        }

        /* 1. Global Spacing & Reset */
        body {
            padding: var(--sp-safe) !important;
            gap: var(--sp-safe);
            overflow-x: hidden;
            margin: 0 !important;
        }

        /* 2. Compact Grid Layout */
        .main-layout {
            display: grid !important;
            /* Sidebar izq estable, centro flexible, derecha estable */
            grid-template-columns: 320px 1fr 260px !important;
            gap: var(--sp-safe) !important;
            max-width: 1600px !important;
            margin: 0 auto !important;
            align-items: start !important;
            padding-bottom: 0 !important;
        }

        /* 3. Compact Components */
        .card,
        .widget,
        .search-widget,
        .camera-section,
        .ai-assistant,
        .ad-box,
        .internal-comm,
        .chart-container,
        .hero-box,
        .video-box,
        .map-box,
        .order-box,
        .centralita-box,
        .lock-overlay {
            margin-bottom: var(--sp-safe) !important;
            padding: var(--sp-safe) !important;
            border-radius: var(--radius-safe) !important;
            height: auto !important;
            min-height: 0 !important;
        }

        /* Excepciones visuales */
        .video-box,
        .map-box,
        .hero-box,
        .demo-container {
            min-height: 200px !important;
            max-height: 400px !important;
        }

        /* 4. Compact Typography & Forms */
        h1,
        h2,
        h3,
        h4 {
            margin: 0 0 8px 0 !important;
            line-height: 1.2 !important;
        }

        p,
        .small-help {
            margin-bottom: 8px !important;
        }

        input,
        select,
        textarea,
        button {
            padding: 8px 10px !important;
            margin-bottom: 8px !important;
            font-size: 0.9rem !important;
            height: auto !important;
        }

        /* Ajuste específico para evitar inputs gigantes */
        input:not([type="checkbox"]):not([type="radio"]) {
            height: 38px !important;
        }

        .nav-buttons .btn-nav {
            padding: 6px 12px !important;
            font-size: 0.8rem !important;
        }

        /* 5. Mobile Responsiveness */
        @media (max-width: 1024px) {
            .main-layout {
                grid-template-columns: 1fr !important;
                display: flex !important;
                flex-direction: column !important;
            }

            .header {
                flex-direction: column !important;
                align-items: center !important;
                gap: 10px !important;
            }

            .nav-buttons {
                justify-content: center !important;
                flex-wrap: wrap !important;
            }
        }
    </style>
    <style>
        :root {
            --primary: #4ade80;
            --bg: #0b0e14;
            --card: #161b22;
            --text: #e6edf3;
            --btn-bg: #21262d;
            --gold: #e3b341;
            --accent: #00f2ff;
            --danger: #ff4d4d;
            --border: #30363d;
            --muted: #94a3b8;
        }

        /* TEMA CLARO EQUILIBRADO */
        body.light-theme {
            --bg: #f0f2f5;
            --card: #ffffff;
            --text: #1c1e21;
            --btn-bg: #e4e6eb;
            --border: #dddfe2;
            --muted: #606770;
            background: #f0f2f5 !important;
        }

        body.light-theme .hero-box,
        body.light-theme .map-box,
        body.light-theme .ai-assistant,
        body.light-theme .centralita-box,
        body.light-theme .chart-container,
        body.light-theme .partner-rotator,
        body.light-theme .order-box,
        body.light-theme .item,
        body.light-theme .msg-list {
            background: #ffffff !important;
            border-color: #dddfe2 !important;
            color: #1c1e21 !important;
        }

        body.light-theme .master-clock {
            background: #ffffff;
            border-color: var(--primary);
        }

        body.light-theme input,
        body.light-theme select,
        body.light-theme textarea {
            background: #f0f2f5 !important;
            border-color: #dddfe2 !important;
            color: #1c1e21 !important;
        }

        body.light-theme .muted,
        body.light-theme .small-help {
            color: #606770 !important;
        }

        body.light-theme .demo-title,
        body.light-theme .caller-id {
            color: #1c1e21 !important;
        }

        body.light-theme .dial-pad .d-btn {
            background: #f0f2f5;
            color: #1c1e21;
        }

        /* Sistema SOS */
        .sos-active {
            border: 2px solid var(--danger);
            background: rgba(255, 77, 77, 0.05);
            animation: pulse-red 2s infinite;
        }

        @keyframes pulse-red {
            0% {
                box-shadow: 0 0 0 0px rgba(255, 77, 77, 0.4);
            }

            70% {
                box-shadow: 0 0 0 10px rgba(255, 77, 77, 0);
            }

            100% {
                box-shadow: 0 0 0 0px rgba(255, 77, 77, 0);
            }
        }

        /* Estilos de Branding Personalizable */
        .logo-area {
            display: flex;
            align-items: center;
            gap: 12px;
            cursor: pointer;
        }

        #taller-logo {
            width: 50px;
            height: 50px;
            border-radius: 8px;
            object-fit: cover;
            border: 1px solid var(--accent);
        }

        /* Relleno de Utilidades */
        .ad-industrial {
            background: linear-gradient(135deg, #1c1f26 0%, #0b0e14 100%);
            border-left: 4px solid var(--gold);
        }

        .prl-status {
            font-size: 0.8rem;
            border-top: 1px solid #30363d;
            padding-top: 10px;
            margin-top: 10px;
            color: var(--primary);
        }

        /* IA OBD Result Box */
        .ia-result {
            background: #000;
            border: 1px solid var(--accent);
            border-radius: 8px;
            padding: 12px;
            font-size: 0.85rem;
            min-height: 100px;
            line-height: 1.4;
            color: #00f2ff;
            font-family: 'Courier New', monospace;
        }

        .copyright-tag {
            color: var(--primary);
            font-weight: bold;
            letter-spacing: 1px;
        }

        .main-layout {
            display: grid;
            grid-template-columns: 350px 1fr 280px;
            gap: 15px;
            flex: 1;
            /* Permite que ocupe el resto de altura */
            padding-bottom: 0;
            /* Ajuste para quitar espacio extra */
        }

        body {
            background: var(--bg);
            color: var(--text);
            font-family: 'Inter', sans-serif;
            margin: 0;
            padding: 15px;
            display: flex;
            flex-direction: column;
            /* Hace que el footer empuje hacia abajo */
            min-height: 100vh;
            box-sizing: border-box;
            /* Crucial para evitar scroll horizontal por padding */
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            border-bottom: 1px solid var(--btn-bg);
            padding-bottom: 10px;
        }

        .logo-admin {
            font-weight: 800;
            color: var(--primary);
            font-size: 1.5rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .nav-buttons {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        #sos-widget {
            transition: all 0.3s ease;
        }

        .master-clock {
            background: #000;
            color: var(--primary);
            padding: 8px 15px;
            border-radius: 8px;
            border: 1px solid var(--primary);
            font-family: monospace;
            font-size: 1.2rem;
        }

        /* --- Estilos Demo Interactiva --- */
        .demo-container {
            width: 100%;
            height: 260px;
            background: #000;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            overflow: hidden;
            border: 1px solid #333;
            border-radius: 10px;
        }

        .demo-screen {
            position: absolute;
            inset: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: opacity 0.8s ease, transform 0.8s ease;
            transform: scale(0.9);
            padding: 20px;
        }

        .demo-screen.active {
            opacity: 1;
            transform: scale(1);
        }

        .demo-icon {
            font-size: 3rem;
            color: var(--accent);
            margin-bottom: 15px;
            text-shadow: 0 0 15px var(--accent);
        }

        .demo-title {
            font-size: 1.2rem;
            font-weight: 900;
            color: #fff;
            margin-bottom: 8px;
            text-transform: uppercase;
        }

        .demo-text {
            font-size: 0.9rem;
            color: #94a3b8;
            max-width: 80%;
        }

        .demo-bg-fx {
            position: absolute;
            inset: 0;
            background: radial-gradient(circle at center, rgba(0, 242, 255, 0.05) 0%, transparent 70%);
            pointer-events: none;
        }

        .demo-bar {
            position: absolute;
            bottom: 0;
            left: 0;
            height: 3px;
            background: var(--primary);
            width: 0%;
            transition: width 5s linear;
        }

        /* --- Estilos Técnico Virtual y Resaltado --- */
        .highlight-focus {
            outline: 3px solid var(--primary) !important;
            box-shadow: 0 0 20px rgba(74, 222, 128, 0.4) !important;
            transition: all 0.5s ease;
            position: relative;
            z-index: 1001;
        }

        .tech-avatar {
            width: 70px;
            height: 70px;
            background: #111;
            border-radius: 50%;
            border: 2px solid var(--accent);
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 10px;
            position: relative;
            box-shadow: 0 0 10px var(--accent);
        }

        .tech-avatar i {
            font-size: 2rem;
            color: var(--accent);
        }

        .tech-talking {
            position: absolute;
            bottom: -5px;
            right: -5px;
            width: 15px;
            height: 15px;
            background: var(--primary);
            border-radius: 50%;
            animation: pulse-green 1s infinite;
            display: none;
        }

        .tech-talking.active {
            display: block;
        }

        .hero-image-wrap {
            width: 160px;
            height: 90px;
            border-radius: 8px;
            /* Rectangular con bordes suaves */
            overflow: hidden;
            border: 2px solid var(--accent);
            box-shadow: 0 0 15px var(--accent);
            margin-bottom: 15px;
            position: relative;
            background: #000;
        }

        .hero-image-wrap img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        @keyframes pulse-green {
            0% {
                transform: scale(1);
                opacity: 1;
            }

            100% {
                transform: scale(2);
                opacity: 0;
            }
        }

        .main-layout {
            display: grid;
            grid-template-columns: 350px 1fr 280px;
            gap: 15px;
            flex: 1;
        }

        .btn-nav {
            background: var(--btn-bg);
            border: 1px solid #30363d;
            color: white;
            padding: 10px 15px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .search-widget,
        .camera-section,
        .ai-assistant,
        .ad-box,
        .internal-comm {
            background: var(--card);
            padding: 15px;
            border-radius: 12px;
            border: 1px solid #30363d;
            margin-bottom: 15px;
        }

        /* ✅ Reutilizamos tu altura y estilo, sin cambiar layout */
        /* ✅ Reutilizamos tu altura y estilo, sin cambiar layout */
        .video-box,
        .map-box {
            width: 100%;
            min-height: 260px;
            height: auto;
            background: #000;
            border-radius: 12px;
            border: 1px solid #30363d;
            margin-bottom: 15px;
            overflow: hidden;
            box-sizing: border-box;
        }

        /* ✅ Nuevo: HERO (imagen 4) sin tocar diseño general */
        .hero-box {
            width: 100%;
            height: 260px;
            border-radius: 12px;
            border: 1px solid #30363d;
            margin-bottom: 15px;
            overflow: hidden;
            background: #000;
            position: relative;
        }

        .hero-box img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: block;
            filter: saturate(1.05) contrast(1.05);
        }

        .hero-overlay {
            position: absolute;
            inset: 0;
            background: linear-gradient(180deg, rgba(0, 0, 0, 0.25), rgba(0, 0, 0, 0.78));
            pointer-events: none;
        }

        .hero-caption {
            position: absolute;
            left: 12px;
            bottom: 12px;
            right: 12px;
            display: flex;
            align-items: flex-end;
            justify-content: space-between;
            gap: 10px;
            pointer-events: none;
        }

        .hero-caption .t {
            font-weight: 900;
            letter-spacing: 0.3px;
        }

        .hero-caption .s {
            font-size: 0.78rem;
            color: #94a3b8;
        }

        /* ✅ Nuevo: miniatura (imagen 5) junto al nombre */
        .brand-mini {
            width: 60px;
            /* Aumentado un poco más */
            height: 60px;
            border-radius: 10px;
            border: 1px solid #30363d;
            object-fit: cover;
            box-shadow: 0 0 0 2px rgba(0, 242, 255, 0.10);
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 9999;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
        }

        .modal-content {
            background: var(--card);
            margin: 5% auto;
            padding: 25px;
            border-radius: 15px;
            width: 450px;
            border: 1px solid var(--primary);
        }

        input,
        textarea,
        select {
            width: 100%;
            background: #0d1117;
            border: 1px solid #30363d;
            color: white;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 15px;
            box-sizing: border-box;
        }

        footer {
            margin-top: auto;
            padding: 15px;
            border-top: 1px solid #333;
            text-align: center;
            font-size: 0.75rem;
        }

        /* Chart container */
        .chart-container {
            width: 100%;
            max-width: 800px;
            margin: 20px auto;
            background: var(--card);
            border: 1px solid #30363d;
            border-radius: 12px;
            padding: 20px;
            box-sizing: border-box;
        }

        footer {
            margin-top: auto;
            padding: 15px;
            border-top: 1px solid #333;
            text-align: center;
            font-size: 0.75rem;
            color: #666;
        }

        .mini-btn {
            background: #0d1117;
            border: 1px solid #30363d;
            color: #fff;
            padding: 8px 10px;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 800;
            font-size: 0.78rem;
        }

        .mini-btn:hover {
            border-color: var(--primary);
        }

        .pill {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 999px;
            border: 1px solid #30363d;
            font-size: 0.72rem;
            color: #94a3b8;
        }

        .partner-card {
            background: linear-gradient(135deg, rgba(227, 179, 65, 0.12), rgba(0, 0, 0, 0.0));
            border: 1px solid rgba(227, 179, 65, 0.5);
            border-radius: 12px;
            padding: 12px;
        }

        .partner-title {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 10px;
            margin: 0 0 8px 0;
        }

        .badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 4px 10px;
            border-radius: 999px;
            border: 1px solid #30363d;
            font-size: 0.72rem;
            color: #94a3b8;
            background: #0d1117;
            white-space: nowrap;
        }

        .cta {
            width: 100%;
            margin-top: 10px;
            background: var(--gold);
            border: none;
            padding: 10px;
            border-radius: 10px;
            font-weight: 900;
            cursor: pointer;
            color: #000;
        }

        .partner-small {
            font-size: 0.78rem;
            color: #94a3b8;
            line-height: 1.35;
        }

        .partner-rotator {
            background: #0d1117;
            border: 1px solid #30363d;
            border-radius: 10px;
            padding: 10px;
        }

        .partner-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 10px;
            flex-wrap: wrap;
        }

        .partner-name {
            font-weight: 900;
            color: var(--primary);
        }

        .partner-desc {
            font-size: 0.78rem;
            color: #94a3b8;
            margin-top: 6px;
        }

        .pay-btn {
            width: 100%;
            border: none;
            padding: 10px;
            border-radius: 10px;
            font-weight: 900;
            cursor: pointer;
            margin-top: 8px;
        }

        .pay-stripe {
            background: #635bff;
            color: #fff;
        }

        .pay-paypal {
            background: #ffc439;
            color: #111;
        }

        .pay-note {
            font-size: 0.72rem;
            color: #94a3b8;
            margin-top: 8px;
            line-height: 1.35;
        }

        .result-box {
            margin-top: 10px;
            background: #0d1117;
            border: 1px solid #30363d;
            border-radius: 10px;
            padding: 10px;
            max-height: 220px;
            overflow: auto;
            font-size: 0.82rem;
            color: #e6edf3;
        }

        .result-box b {
            color: var(--primary);
        }

        .result-box .sec {
            margin: 8px 0 6px;
            color: #94a3b8;
            font-weight: 800;
            letter-spacing: 0.02em;
        }

        .muted {
            color: #94a3b8;
        }

        /* ✅ OBD UI (no cambia estilo base) */
        .obd-row {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            align-items: center;
        }

        .obd-row input {
            margin: 0;
            flex: 1;
            min-width: 170px;
            text-transform: uppercase;
            font-weight: 900;
            letter-spacing: 0.6px;
        }

        .obd-btn {
            background: var(--accent);
            color: #000;
            border: none;
            padding: 10px 12px;
            border-radius: 10px;
            font-weight: 900;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .obd-btn:disabled {
            opacity: 0.55;
            cursor: not-allowed;
        }

        /* ✅ Mensajería: panel scroll */
        .msg-list {
            background: #0d1117;
            border: 1px solid #30363d;
            border-radius: 10px;
            padding: 10px;
            max-height: 220px;
            overflow: auto;
            font-size: 0.82rem;
        }

        .msg-item {
            padding: 8px 0;
            border-bottom: 1px dashed #30363d;
        }

        .msg-item:last-child {
            border-bottom: none;
        }

        .msg-meta {
            color: #94a3b8;
            font-size: 0.72rem;
            margin-bottom: 4px;
            display: flex;
            justify-content: space-between;
            gap: 10px;
        }

        .msg-text {
            color: #e6edf3;
            white-space: pre-wrap;
            word-break: break-word;
        }

        .msg-tools {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            margin-top: 10px;
            align-items: center;
        }

        .role-pill {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 10px;
            border-radius: 999px;
            border: 1px solid #30363d;
            background: #0d1117;
            font-size: 0.75rem;
            color: #94a3b8;
            cursor: pointer;
            user-select: none;
        }

        .role-pill.active {
            border-color: var(--primary);
            color: var(--primary);
            box-shadow: 0 0 0 2px rgba(74, 222, 128, 0.10);
        }

        /* ✅ NUEVO: formularios (estilo compatible, sin tocar layout) */
        .form-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }

        .form-grid .full {
            grid-column: 1 / -1;
        }

        .small-help {
            font-size: 0.74rem;
            color: #94a3b8;
            line-height: 1.35;
            margin-top: -6px;
            margin-bottom: 10px;
        }

        .divider {
            height: 1px;
            background: #30363d;
            margin: 10px 0;
            opacity: 0.7;
        }

        .kpi-row {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            margin-top: 8px;
        }

        .kpi {
            flex: 1;
            min-width: 140px;
            background: #0d1117;
            border: 1px solid #30363d;
            border-radius: 12px;
            padding: 10px;
        }

        .kpi .t {
            font-size: 0.72rem;
            color: #94a3b8;
        }

        .kpi .v {
            font-size: 0.92rem;
            font-weight: 900;
            color: #e6edf3;
            margin-top: 4px;
        }

        /* ✅ NUEVO: YouTube mini box */
        .yt-wrap {
            background: #0d1117;
            border: 1px solid #30363d;
            border-radius: 12px;
            overflow: hidden;
        }

        .yt-head {
            padding: 10px;
            border-bottom: 1px solid #30363d;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 10px;
        }

        .yt-head b {
            color: var(--accent);
        }

        .yt-body {
            padding: 10px;
        }

        .yt-iframe {
            width: 100%;
            height: 180px;
            border: 0;
            border-radius: 10px;
            overflow: hidden;
            background: #000;
        }

        /* ✅ NUEVO: grabadora */
        .rec-row {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            align-items: center;
        }

        .rec-btn {
            border: none;
            border-radius: 10px;
            padding: 10px 12px;
            font-weight: 900;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .rec-start {
            background: var(--primary);
            color: #000;
        }

        .rec-stop {
            background: #e74c3c;
            color: #fff;
        }

        .rec-save {
            background: var(--accent);
            color: #000;
        }

        .rec-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .audio-list .item {
            border-bottom: 1px dashed #30363d;
            padding: 10px 0;
        }

        .audio-list .item:last-child {
            border-bottom: none;
        }

        .audio-meta {
            display: flex;
            justify-content: space-between;
            gap: 10px;
            flex-wrap: wrap;
            font-size: 0.72rem;
            color: #94a3b8;
            margin-bottom: 6px;
        }

        /* ==========================================================
           ✅ BLOQUEO (PIN + PATRÓN) - lo respetamos
           ========================================================== */
        .lock-overlay {
            position: fixed;
            inset: 0;
            z-index: 99999;
            background: rgba(0, 0, 0, 0.92);
            display: none;
            align-items: center;
            justify-content: center;
            padding: 16px;
        }

        .lock-card {
            width: min(520px, 96vw);
            background: var(--card);
            border: 1px solid #30363d;
            border-radius: 16px;
            padding: 18px;
            box-shadow: 0 0 0 1px rgba(74, 222, 128, 0.15);
        }

        .lock-title {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 10px;
            margin-bottom: 12px;
        }

        .lock-title h3 {
            margin: 0;
            color: var(--primary);
            font-size: 1.05rem;
            letter-spacing: 0.3px;
        }

        .lock-sub {
            margin: 0 0 12px 0;
            font-size: 0.82rem;
            color: #94a3b8;
        }

        .lock-row {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .lock-row>div {
            flex: 1;
            min-width: 220px;
        }

        .lock-mini {
            font-size: 0.78rem;
            color: #94a3b8;
            margin-bottom: 8px;
        }

        .lock-input {
            width: 100%;
            background: #0d1117;
            border: 1px solid #30363d;
            color: #fff;
            padding: 12px;
            border-radius: 10px;
            box-sizing: border-box;
            margin-bottom: 0;
        }

        .lock-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-top: 12px;
        }

        .lock-btn {
            background: var(--btn-bg);
            border: 1px solid #30363d;
            color: #fff;
            padding: 10px 12px;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 900;
            font-size: 0.82rem;
        }

        .lock-btn.primary {
            background: var(--primary);
            color: #000;
            border: 1px solid rgba(74, 222, 128, 0.6);
        }

        .lock-btn.danger {
            background: #e74c3c;
            border: 1px solid rgba(231, 76, 60, 0.6);
        }

        .lock-hint {
            margin-top: 10px;
            font-size: 0.78rem;
            color: #94a3b8;
        }

        .lock-error {
            margin-top: 10px;
            font-size: 0.82rem;
            color: #ff6b6b;
            display: none;
        }

        .pattern-wrap {
            background: #0d1117;
            border: 1px solid #30363d;
            border-radius: 12px;
            padding: 12px;
        }

        .pattern-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            user-select: none;
            touch-action: none;
        }

        .dot {
            width: 60px;
            height: 60px;
            max-width: 18vw;
            max-height: 18vw;
            margin: auto;
            border-radius: 999px;
            border: 2px solid #30363d;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }

        .dot::after {
            content: '';
            width: 14px;
            height: 14px;
            border-radius: 999px;
            background: #1f2937;
        }

        .dot.active {
            border-color: var(--accent);
            box-shadow: 0 0 0 3px rgba(0, 242, 255, 0.12);
        }

        .dot.active::after {
            background: var(--accent);
        }

        .pattern-preview {
            margin-top: 10px;
            font-family: monospace;
            font-size: 0.8rem;
            color: #94a3b8;
            word-break: break-all;
        }

        .small-pill {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 999px;
            border: 1px solid #30363d;
            font-size: 0.72rem;
            color: #94a3b8;
        }

        button:focus,
        input:focus,
        textarea:focus,
        select:focus {
            outline: 2px solid rgba(0, 242, 255, 0.25);
            outline-offset: 2px;
        }

        /* ==========================================================
           ✅ CENTRALITA STYLES
           ========================================================== */
        .centralita-box {
            background: linear-gradient(135deg, #161b22 0%, #0d1117 100%);
            border: 1px solid #30363d;
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 20px;
            position: relative;
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .centralita-box.talking {
            border-color: var(--accent);
            box-shadow: 0 0 20px rgba(0, 242, 255, 0.15);
        }

        .centralita-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .status-dot {
            width: 10px;
            height: 10px;
            background: #444;
            border-radius: 50%;
            display: inline-block;
            margin-right: 8px;
        }

        .status-dot.active {
            background: var(--primary);
            box-shadow: 0 0 8px var(--primary);
        }

        .status-dot.ringing {
            background: var(--danger);
            animation: pulse-red 1s infinite;
        }

        .equalizer-wrap {
            display: flex;
            align-items: flex-end;
            justify-content: center;
            gap: 3px;
            height: 60px;
            margin: 15px 0;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 8px;
            padding: 10px;
        }

        .eq-bar {
            width: 6px;
            background: var(--accent);
            border-radius: 3px 3px 0 0;
            height: 10px;
            transition: height 0.1s ease, opacity 0.1s ease;
            opacity: 0.4;
        }

        .call-display {
            background: #000;
            border: 1px solid #333;
            border-radius: 12px;
            padding: 15px;
            text-align: center;
            margin-bottom: 15px;
        }

        .caller-id {
            font-size: 1.4rem;
            font-weight: 900;
            color: #fff;
            margin-bottom: 5px;
            letter-spacing: 1px;
        }

        .call-status-text {
            font-size: 0.8rem;
            color: var(--accent);
            font-family: monospace;
            text-transform: uppercase;
        }

        .centralita-actions {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            gap: 10px;
        }

        .c-btn {
            background: #21262d;
            border: 1px solid #30363d;
            color: #fff;
            padding: 12px;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 800;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
            font-size: 0.75rem;
            transition: all 0.2s;
        }

        .c-btn:hover:not(:disabled) {
            background: #30363d;
            border-color: var(--accent);
        }

        .c-btn i {
            font-size: 1.2rem;
        }

        .c-btn.btn-hangup {
            color: var(--danger);
        }

        .c-btn.btn-hangup:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }

        .c-btn.active {
            border-color: var(--primary);
            color: var(--primary);
        }

        .c-overlay {
            position: absolute;
            inset: 0;
            background: rgba(13, 17, 23, 0.98);
            z-index: 10;
            display: none;
            flex-direction: column;
            padding: 20px;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }

        .dial-pad {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-top: 10px;
        }

        .d-btn {
            background: #21262d;
            border: 1px solid #30363d;
            color: #fff;
            padding: 15px;
            border-radius: 8px;
            font-size: 1.2rem;
            font-weight: bold;
            cursor: pointer;
        }

        .d-btn:active {
            background: var(--accent);
            color: #000;
        }

        .d-btn.d-call {
            grid-column: span 3;
            background: var(--primary);
            color: #000;
        }

        .call-log {
            margin-top: 20px;
            border-top: 1px solid #30363d;
            padding-top: 15px;
        }

        .log-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px dashed #222;
        }

        .log-item:last-child {
            border-bottom: none;
        }

        .msg-badge {
            font-size: 0.6rem;
            padding: 2px 5px;
            border-radius: 4px;
            background: var(--accent);
            color: #000;
            font-weight: 900;
            margin-left: 5px;
        }

        .vol-slider-wrap {
            display: none;
            align-items: center;
            gap: 10px;
            background: #000;
            padding: 10px;
            border-radius: 8px;
            margin-top: 10px;
        }

        .vol-slider {
            flex: 1;
            accent-color: var(--accent);
        }

        .c-agenda-wrap {
            max-height: 200px;
            overflow-y: auto;
        }

        .agenda-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            border-bottom: 1px solid #222;
            cursor: pointer;
        }

        .agenda-item:hover {
            background: rgba(255, 255, 255, 0.05);
        }
    </style>
</head>

<body>

    <div class="header">
        <div class="logo-area" onclick="configurarTaller()">
            <img id="taller-logo" src="../static/admin-mini-new.jpg" class="brand-mini" alt="Logo Taller">
            <div>
                <div id="taller-nombre" style="font-weight: 800; font-size: 1.2rem; color:var(--primary);">AutomaDrive
                    Pro</div>
                <small style="display:block; font-size: 0.6em; color: var(--gold);">SISTEMA CONECTADO A
                    AUTOMADRIVE</small>
            </div>
        </div>
        <div class="nav-buttons">
            <button class="btn-nav" onclick="toggleActividad()"><i class="fas fa-history"></i> ACTIVIDAD</button>
            <button class="btn-nav" onclick="nuevaFicha()"><i class="fas fa-plus"></i> NUEVO INGRESO</button>
            <button class="btn-nav" style="background:var(--danger); border-color:var(--danger);"
                onclick="triggerManualSOS()"><i class="fas fa-ambulance"></i> SOS</button>
            <button class="btn-nav" style="border:1px solid var(--primary);" onclick="toggleTheme()" id="theme-toggle"
                title="Cambiar Tema"><i class="fas fa-sun"></i></button>
            <div class="master-clock" id="reloj-maestro">00:00:00</div>
        </div>
    </div>

    <div class="main-layout">
        <div class="left-col">
            <!-- ✅ WIDGET SOS HOMBRE CAÍDO -->
            <div class="widget sos-active" id="sos-widget" style="margin-bottom:15px;">
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <b style="color:var(--danger)"><i class="fas fa-shield-virus"></i> SISTEMA HOMBRE CAÍDO</b>
                    <span class="badge" style="background:var(--danger); color:white;">ACTIVO</span>
                </div>
                <p style="font-size:0.75rem; color:#94a3b8; margin:5px 0;">Acelerómetro activo. En caso de impacto, la
                    IA contactará con emergencias indicando coordenadas foso/elevador.</p>
                <div id="sos-status" style="font-size:0.7rem; font-weight:bold; color:var(--text);">ESTADO: ESCANEANDO
                    MOVIMIENTO</div>
            </div>

            <!-- ✅ WIDGET SEGURIDAD (PRL) -->
            <div class="widget" style="margin-bottom:15px;">
                <b><i class="fas fa-hard-hat"></i> SEGURIDAD EN EL TRABAJO</b>
                <div id="prl-info" style="font-size:0.8rem; margin-top:10px; color:var(--primary);">
                    Cargando normativa actualizada...
                </div>
                <div class="prl-status"><i class="fas fa-check-circle"></i> EPIS verificados hoy</div>
            </div>
            <div class="search-widget" style="background:white; color:#333;">
                <div style="font-size:0.7em; font-weight:bold; margin-bottom:5px;">BUSCAR EXPEDIENTE</div>
                <div style="display:flex; border:2px solid #000; border-radius:8px; overflow:hidden;">
                    <div style="background:#003366; color:white; padding:10px; font-weight:bold;">E</div>
                    <input type="text" id="widget-search" placeholder="0000 BBB"
                        style="margin:0; border:none; color:#000; background:#fff; text-transform:uppercase; font-weight:bold;">
                    <button onclick="buscarDesdeWidget()"
                        style="background:#000; color:var(--primary); border:none; padding:10px; cursor:pointer;">GO</button>
                </div>
                <div id="search-status" style="margin-top:8px; font-size:0.8rem; color:#111; opacity:0.85;"></div>
            </div>

            <div class="camera-section">
                <button class="btn-nav"
                    style="width:100%; background: var(--primary); color: #000; justify-content:center;"
                    onclick="document.getElementById('camera-input').click()">
                    <i class="fas fa-camera"></i> CAPTURAR AVER&Iacute;A
                </button>
                <input type="file" id="camera-input" accept="image/*" capture="environment" style="display:none">
                <div style="margin-top:10px; display:flex; gap:8px; flex-wrap:wrap;">
                    <span class="pill">Evidencia firmada (hash)</span>
                    <span class="pill">Hora &amp; dispositivo</span>
                    <span class="pill">Geo opcional</span>
                </div>
            </div>

            <div class="ai-assistant">
                <div style="color:var(--primary); font-weight:bold; margin-bottom:10px;"><i class="fas fa-robot"></i>
                    CONSULTA T&Eacute;CNICA</div>
                <div id="ai-chat-admin"
                    style="height:110px; font-size:0.8rem; color:#4ade80; overflow-y:auto; margin-bottom:10px;">Listo...
                </div>
                <input type="text" id="ai-admin-input" placeholder="Pregunta algo..." style="margin:0;">
                <div id="ai-status" class="muted" style="margin-top:8px; font-size:0.72rem;">&nbsp;</div>
            </div>

            <div class="ai-assistant" style="border-color: var(--accent);">
                <div style="color:var(--accent); font-weight:900; margin-bottom:10px;">
                    <i class="fas fa-brain"></i> DIAGN&Oacute;STICO GUIADO
                </div>

                <div style="display:flex; gap:8px; flex-wrap:wrap; margin-bottom:10px;">
                    <button class="mini-btn" onclick="diagStart('no_arranca')">No arranca</button>
                    <button class="mini-btn" onclick="diagStart('tirones')">Tirones</button>
                    <button class="mini-btn" onclick="diagStart('vibracion')">Vibraci&oacute;n</button>
                    <button class="mini-btn" onclick="diagStart('testigo_motor')">Testigo motor</button>
                    <button class="mini-btn" onclick="diagStart('humo')">Humo</button>
                    <button class="mini-btn" onclick="diagStart('frenos')">Frenos</button>
                </div>

                <div id="diag-box"
                    style="background:#0d1117; border:1px solid #30363d; border-radius:10px; padding:10px;">
                    <div style="font-size:0.78rem; color:#94a3b8; margin-bottom:8px;">Responde con los botones para
                        obtener un protocolo.</div>
                    <div id="diag-q" style="font-weight:900; margin-bottom:10px;">Selecciona un s&iacute;ntoma para
                        empezar.</div>
                    <div id="diag-actions" style="display:flex; gap:8px; flex-wrap:wrap;"></div>
                    <div id="diag-result" class="result-box" style="display:none;"></div>
                </div>

                <div style="margin-top:10px; display:flex; gap:8px; flex-wrap:wrap;">
                    <button class="mini-btn" onclick="diagReset()">Reset</button>
                    <button class="mini-btn" onclick="diagCopyClient()">Copiar texto cliente</button>
                </div>
            </div>

            <!-- =====================================================
                 ✅ NUEVO (IZQUIERDA): FORMULARIOS GM-NET MEJORADOS
                 Debajo del cuadro de diagnóstico guiado
                 ===================================================== -->

            <!-- ✅ 1) RECEPCIÓN / CHECK-IN -->
            <div id="rx-box" class="ai-assistant" style="border-color: var(--primary);">
                <div
                    style="display:flex; align-items:center; justify-content:space-between; gap:10px; margin-bottom:10px;">
                    <div style="color:var(--primary); font-weight:900;">
                        <i class="fas fa-clipboard-check"></i> RECEPCI&Oacute;N INTELIGENTE (CHECK-IN)
                    </div>
                    <span class="badge">60s</span>
                </div>

                <div class="small-help">
                    Flujo tipo GM-net pero mejorado: <b>checklist + evidencia + firma</b>. Guarda borrador local o
                    env&iacute;a al servidor si lo tienes.
                </div>

                <div class="form-grid">
                    <input class="full" id="rx_matricula" type="text" placeholder="Matrícula / Expediente (ej: 1234ABC)"
                        style="text-transform:uppercase; font-weight:900;">
                    <input id="rx_cliente" type="text" placeholder="Cliente">
                    <input id="rx_tel" type="text" placeholder="WhatsApp / Teléfono">

                    <input id="rx_km" type="number" placeholder="Kilómetros" inputmode="numeric">
                    <select id="rx_comb">
                        <option value="">Combustible (aprox.)</option>
                        <option>0-1/4</option>
                        <option>1/4-1/2</option>
                        <option>1/2-3/4</option>
                        <option>3/4-1/1</option>
                    </select>

                    <select id="rx_tipo" class="full">
                        <option value="">Plantilla rápida</option>
                        <option value="revision">Revisión / Mantenimiento</option>
                        <option value="itv">Pre-ITV</option>
                        <option value="frenos">Frenos</option>
                        <option value="neumaticos">Neumáticos</option>
                        <option value="diagnostico">Diagnóstico avería</option>
                        <option value="chapa">Chapa / Pintura</option>
                    </select>

                    <textarea class="full" id="rx_sintomas" rows="3"
                        placeholder="Síntomas (en palabras del cliente): ruido, vibración, humo..."></textarea>

                    <div class="full kpi-row">
                        <div class="kpi">
                            <div class="t">Daños visibles</div>
                            <div class="v" id="rx_dmg">—</div>
                        </div>
                        <div class="kpi">
                            <div class="t">Accesorios</div>
                            <div class="v" id="rx_acc">—</div>
                        </div>
                    </div>

                    <div class="full" style="display:flex; gap:8px; flex-wrap:wrap;">
                        <button class="mini-btn" onclick="rxToggle('dmg')" title="Golpes/arañazos visibles">
                            <i class="fas fa-car-burst"></i> Da&ntilde;os
                        </button>
                        <button class="mini-btn" onclick="rxToggle('acc')"
                            title="Triángulos, rueda repuesto, gato, etc.">
                            <i class="fas fa-box"></i> Accesorios
                        </button>
                        <button class="mini-btn" onclick="rxUseDiagText()">
                            <i class="fas fa-wand-magic-sparkles"></i> Usar texto del diagn&oacute;stico guiado
                        </button>
                    </div>

                    <div class="full" style="display:flex; gap:8px; flex-wrap:wrap;">
                        <button class="mini-btn" onclick="rxSaveDraft()"><i class="fas fa-floppy-disk"></i> Guardar
                            borrador</button>
                        <button class="mini-btn" onclick="rxLoadDraft()"><i class="fas fa-folder-open"></i>
                            Cargar</button>
                        <button class="mini-btn" style="border-color:var(--primary);" onclick="rxCreateOT()">
                            <i class="fas fa-screwdriver-wrench"></i> Crear OT
                        </button>
                    </div>

                    <div id="rx_status" class="muted full" style="font-size:0.72rem;">&nbsp;</div>
                </div>
            </div>

            <!-- ✅ 2) OT + PRESUPUESTO + APROBACIÓN -->
            <div class="ai-assistant" style="border-color:#a5b4fc;">
                <div
                    style="display:flex; align-items:center; justify-content:space-between; gap:10px; margin-bottom:10px;">
                    <div style="color:#a5b4fc; font-weight:900;">
                        <i class="fas fa-file-lines"></i> ORDEN DE TRABAJO (OT) + PRESUPUESTO
                    </div>
                    <span class="badge">Kanban-ready</span>
                </div>

                <div class="small-help">
                    OT r&aacute;pida: mano de obra + recambios + estado. Puedes enviar presupuesto por WhatsApp/email
                    (cuando conectes backend).
                </div>

                <div class="form-grid">
                    <input class="full" id="ot_ref" type="text" placeholder="OT / Referencia (auto si está vacío)">
                    <select id="ot_estado">
                        <option value="recibido">Recibido</option>
                        <option value="diagnostico">Diagnóstico</option>
                        <option value="presupuesto">Presupuesto</option>
                        <option value="aprobado">Aprobado</option>
                        <option value="reparacion">En reparación</option>
                        <option value="listo">Listo</option>
                        <option value="entregado">Entregado</option>
                    </select>
                    <input id="ot_mecanico" type="text" placeholder="Mecánico asignado">

                    <textarea class="full" id="ot_trabajos" rows="3"
                        placeholder="Trabajos a realizar (ej: cambiar pastillas, diagnosis OBD, etc.)"></textarea>

                    <input id="ot_horas" type="number" step="0.1" placeholder="Horas mano de obra (ej: 1.5)">
                    <input id="ot_precio_hora" type="number" step="0.01" placeholder="Precio/hora (€)">
                    <input class="full" id="ot_recambios" type="text"
                        placeholder="Recambios (texto rápido: Pastillas Brembo x1, Filtro aceite x1...)">

                    <div class="full" style="display:flex; gap:8px; flex-wrap:wrap;">
                        <button class="mini-btn" onclick="otCalc()"><i class="fas fa-calculator"></i> Calcular</button>
                        <button class="mini-btn" onclick="otSaveLocal()"><i class="fas fa-floppy-disk"></i> Guardar OT
                            (local)</button>
                        <button class="mini-btn" onclick="otSendBudget()"><i class="fas fa-paper-plane"></i> Enviar
                            presupuesto</button>
                        <button class="mini-btn" style="background:#25D366; color:#fff; border:none;"
                            onclick="otSendWhatsapp()">
                            <i class="fab fa-whatsapp"></i> Enviar WA
                        </button>
                    </div>

                    <div class="full" id="ot_totals"
                        style="background:#0d1117; border:1px solid #30363d; border-radius:12px; padding:10px;">
                        <div class="muted" style="font-size:0.78rem;">Totales</div>
                        <div style="display:flex; gap:8px; flex-wrap:wrap; margin-top:6px;">
                            <span class="badge">MO: <b id="tot_mo">0.00€</b></span>
                            <span class="badge">Recambios: <b id="tot_rec">0.00€</b></span>
                            <span class="badge">Subtotal: <b id="tot_sub">0.00€</b></span>
                            <span class="badge">IVA: <b id="tot_iva">0.00€</b></span>
                            <span class="badge">Total: <b id="tot_total">0.00€</b></span>
                        </div>
                    </div>

                    <div id="ot_status" class="muted full" style="font-size:0.72rem;">&nbsp;</div>
                </div>
            </div>

            <!-- ✅ 3) FACTURACIÓN MOVIDA A COLUMNA DERECHA -->

            <!-- ✅ 4) Cuadro pequeño de YouTube (mecánica) -->
            <div class="ai-assistant" style="border-color: var(--accent);">
                <div
                    style="display:flex; align-items:center; justify-content:space-between; gap:10px; margin-bottom:10px;">
                    <div style="color:var(--accent); font-weight:900;">
                        <i class="fab fa-youtube"></i> VIDEOS MEC&Aacute;NICA (YouTube)
                    </div>
                    <span class="badge">Auto-learning</span>
                </div>

                <div class="small-help">
                    Pon aqu&iacute; videos r&aacute;pidos para el equipo. Puedes cambiar el canal/playlist o buscar por
                    palabra.
                </div>

                <div class="yt-wrap">
                    <div class="yt-head">
                        <b id="yt_title">Playlist Mec&aacute;nica</b>
                        <button class="mini-btn" onclick="ytOpen()"><i class="fas fa-up-right-from-square"></i>
                            Abrir</button>
                    </div>
                    <div class="yt-body">
                        <input id="yt_query" type="text" placeholder="Buscar (ej: P0420, EGR, frenos, embrague)"
                            style="margin:0;">
                        <div style="display:flex; gap:8px; flex-wrap:wrap; margin-top:10px;">
                            <button class="mini-btn" onclick="ytSearch()"><i class="fas fa-magnifying-glass"></i>
                                Buscar</button>
                            <button class="mini-btn" onclick="ytSetDefault()"><i class="fas fa-rotate"></i> Volver
                                playlist</button>
                        </div>
                        <div class="divider"></div>
                        <iframe id="yt_iframe" class="yt-iframe"
                            src="https://www.youtube.com/embed/videoseries?list=PLrEnWoR732-D67iteOI6DPdJH1opjAuJt"
                            allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
                            allowfullscreen>
                        </iframe>
                        <div class="muted" style="font-size:0.72rem; margin-top:10px;">
                            * Puedes sustituir la playlist por la tuya en el JS: <b>YT_DEFAULT</b>.
                        </div>
                    </div>
                </div>
            </div>




        </div>

        <!-- ✅ CENTRO: HERO + IA OBD -->
        <div class="center-col">

            <!-- ✅ HERO (4ª imagen) -->
            <div class="hero-box">
                <img src="../static/admin-hero.jpg" alt="AutomaDrive Pro Hero">
                <div class="hero-overlay"></div>
                <div class="hero-caption">
                    <div>
                        <div class="t">AutomaDrive Pro</div>
                        <div class="s">Gestión + Diagnóstico + Evidencias (modo taller)</div>
                    </div>
                    <div class="badge"><i class="fas fa-bolt" style="color:var(--accent);"></i> PRO</div>
                </div>
            </div>

            <!-- ✅ IA OBD (reemplaza Maps) -->
            <!-- ✅ IA OBD MEJORADA (Contexto + Causa Raíz) -->
            <div id="ia-obd-box" class="map-box"
                style="background: var(--card); padding: 15px; border-color: var(--accent);">
                <div
                    style="display:flex; align-items:center; justify-content:space-between; gap:10px; margin-bottom:10px;">
                    <div style="font-weight:900; color: var(--accent);">
                        <i class="fas fa-robot"></i> IA EXPERTA EN DIAGNÓSTICO
                    </div>
                    <span class="badge">DATASET 2026-2050</span>
                </div>

                <div style="display:flex; gap:10px; margin-bottom:10px;">
                    <input type="text" id="obd-code" placeholder="CÓDIGO DTC (Ej: P0420)"
                        style="font-size:1.2rem; font-weight:bold; flex:2;">
                    <button class="btn-pro"
                        style="flex:1; background:var(--accent); color:#000; justify-content:center;"
                        onclick="consultarIAOBD()">ANALIZAR</button>
                </div>

                <input type="text" id="obd-model" placeholder="Contexto: Marca, Modelo, Motor, Año (Ej: BMW 320d 2021)"
                    style="margin-bottom:10px;">

                <div id="ia-output" class="ia-result">
                    Introduce un código para iniciar el análisis profundo. La IA analizará la causa raíz, no solo
                    borrará el fallo.
                </div>

                <div style="margin-top:10px; display:flex; gap:10px;">
                    <button class="btn-pro" style="font-size:0.7rem; justify-content:center;"
                        onclick="copiarProtocolo()"><i class="fas fa-copy"></i> COPIAR PASOS TALLER</button>
                    <button class="btn-pro" style="font-size:0.7rem; justify-content:center;"><i
                            class="fas fa-file-pdf"></i> GENERAR INFORME CLIENTE</button>
                </div>
            </div>

            <!-- ✅ TOUR INTERACTIVO -->
            <div class="map-box"
                style="background: var(--card); padding: 15px; border-color: var(--primary); height: auto !important; max-height: none !important;">
                <div
                    style="display:flex; align-items:center; justify-content:space-between; gap:10px; margin-bottom:10px;">
                    <div style="font-weight:900; color: var(--primary);">
                        <i class="fas fa-play-circle"></i> Tour Interactivo AutomaDrive
                    </div>
                    <span class="badge" id="demo-status-pill">REPRODUCIENDO</span>
                </div>

                <div class="demo-container"
                    style="cursor: default; height: auto !important; max-height: none !important; width: 100%; padding-bottom: 0;">
                    <video width="1900" height="1080" controls autoplay muted
                        style="display: block; width: 100%; height: auto; aspect-ratio: 1900/1080;">
                        <source src="../static/Bienvenido a Automadrive.mp4" type="video/mp4">
                        Tu navegador no soporta video HTML5.
                    </video>
                    <!-- Watermark Overlay -->
                    <div
                        style="position: absolute; inset: 0; display: flex; align-items: center; justify-content: center; pointer-events: none; z-index: 10; overflow: hidden;">
                        <div
                            style="transform: rotate(-15deg); font-size: 5vw; font-weight: 900; color: rgba(255, 255, 255, 0.12); text-transform: uppercase; white-space: nowrap; user-select: none;">
                            AUTOMADRIVE<br>PREVIEW
                        </div>
                    </div>
                </div>
            </div>

            <!-- ✅ CENTRALITA VIRTUAL IA -->
            <div class="centralita-box" id="centralita-ui">
                <div class="centralita-header">
                    <div style="display:flex; align-items:center;">
                        <span class="status-dot" id="c-status-dot"></span>
                        <b style="color:var(--accent); font-size:0.9rem;">CENTRALITA VIRTUAL (REAL VOIP)</b>
                    </div>
                    <div style="display:flex; align-items:center; gap:10px;">
                        <span id="c-net-label" style="font-size:0.7rem; color:var(--primary);">WIFI:
                            CONECTANDO...</span>
                        <div style="display:flex; gap:2px;">
                            <div class="s-bar active" style="width:3px; height:8px; background:var(--primary);"></div>
                            <div class="s-bar active" style="width:3px; height:10px; background:var(--primary);"></div>
                            <div class="s-bar" style="width:3px; height:12px; background:#444;"></div>
                        </div>
                    </div>
                </div>

                <div class="equalizer-wrap" id="c-eq">
                    <div class="eq-bar" style="height:15px;"></div>
                    <div class="eq-bar" style="height:25px;"></div>
                    <div class="eq-bar" style="height:40px;"></div>
                    <div class="eq-bar" style="height:30px;"></div>
                    <div class="eq-bar" style="height:45px;"></div>
                    <div class="eq-bar" style="height:20px;"></div>
                    <div class="eq-bar" style="height:35px;"></div>
                    <div class="eq-bar" style="height:15px;"></div>
                </div>

                <div class="call-display">
                    <div class="caller-id" id="c-caller-id">SISTEMA EN ESPERA</div>
                    <div class="call-status-text" id="c-display-status">WIFI CONECTADO - SIN LLAMADAS</div>
                </div>

                <!-- OVERLAY DIALER -->
                <div id="c-dialer-overlay" class="c-overlay">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                        <b style="color:var(--accent);">MARCACIÓN MANUAL</b><i class="fas fa-times"
                            onclick="cCloseDialer()" style="cursor:pointer;"></i>
                    </div>
                    <input type="text" id="c-dial-input" placeholder="Introduce número..."
                        style="font-size:1.5rem; text-align:center; background:#000; border-color:var(--accent); margin-bottom:10px;">
                    <div class="dial-pad">
                        <button class="d-btn" onclick="cDialAdd('1')">1</button>
                        <button class="d-btn" onclick="cDialAdd('2')">2</button>
                        <button class="d-btn" onclick="cDialAdd('3')">3</button>
                        <button class="d-btn" onclick="cDialAdd('4')">4</button>
                        <button class="d-btn" onclick="cDialAdd('5')">5</button>
                        <button class="d-btn" onclick="cDialAdd('6')">6</button>
                        <button class="d-btn" onclick="cDialAdd('7')">7</button>
                        <button class="d-btn" onclick="cDialAdd('8')">8</button>
                        <button class="d-btn" onclick="cDialAdd('9')">9</button>
                        <button class="d-btn" onclick="cDialAdd('*')">*</button>
                        <button class="d-btn" onclick="cDialAdd('0')">0</button>
                        <button class="d-btn" onclick="cDialAdd('#')">#</button>
                        <button class="d-btn d-call" onclick="cMakeManualCall()"><i class="fas fa-phone"></i> LLAMAR
                            AHORA</button>
                    </div>
                    <button class="mini-btn" style="width:100%; margin-top:15px; border-color:#666;"
                        onclick="cCloseDialer()"><i class="fas fa-arrow-left"></i> VOLVER AL PANEL</button>
                </div>

                <!-- OVERLAY AGENDA -->
                <div id="c-agenda-overlay" class="c-overlay">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                        <b style="color:var(--accent);">AGENDA DE CONTACTOS</b><i class="fas fa-times"
                            onclick="cCloseAgenda()" style="cursor:pointer;"></i>
                    </div>
                    <div class="c-agenda-wrap" id="c-agenda-list">
                        <!-- Items sync via JS -->
                    </div>
                    <button class="mini-btn" style="width:100%; margin-top:15px; border-color:#666;"
                        onclick="cCloseAgenda()"><i class="fas fa-arrow-left"></i> VOLVER AL PANEL</button>
                </div>

                <div class="centralita-actions">
                    <button class="c-btn btn-call" id="c-btn-call" onclick="cOpenDialer()"><i
                            class="fas fa-phone"></i>LLAMAR </button>
                    <button class="c-btn" onclick="cOpenAgenda()"><i class="fas fa-address-book"></i>AGENDA </button>
                    <button class="c-btn btn-hangup" id="c-btn-hangup" onclick="cHangup()" disabled><i
                            class="fas fa-phone-slash"></i>COLGAR </button>
                    <button class="c-btn btn-vol" onclick="toggleVolSlider()"><i class="fas fa-volume-high"></i>VOLUMEN
                    </button>
                    <button class="c-btn" onclick="cToggleListening()" id="c-btn-mic"><i
                            class="fas fa-microphone"></i>ACTIVA </button>
                    <div class="vol-slider-wrap" id="c-vol-wrap">
                        <i class="fas fa-volume-low muted"></i>
                        <input type="range" class="vol-slider" min="0" max="100" value="80"
                            onchange="cSetVolume(this.value)">
                        <i class="fas fa-volume-high muted"></i>
                    </div>
                </div>

                <div class="call-log">
                    <div style="font-size: 0.75rem; color: #94a3b8; font-weight: 800; margin-bottom: 8px;"><i
                            class="fas fa-history"></i>REGISTRO DE LLAMADAS Y RECADOS </div>
                    <div id="c-log-list">
                        <div class="muted" style="font-size: 0.7rem; text-align: center; padding: 10px;">Sin actividad
                            reciente</div>
                    </div>
                </div>
            </div>

            <!-- ✅ CHART.JS -->
            <div class="chart-container" style="margin: 0; width:100% !important; max-width:none;">
                <h4 style="color: var(--primary); margin-top:0; text-align:center;"><i class="fas fa-chart-line"></i>
                    TALLERES
                    CONECTADOS (2025)</h4>
                <canvas id="talleresChart"></canvas>
            </div>

            <!-- ✅ FORO DE FEEDBACK -->
            <div class="ai-assistant" style="margin-top: 15px; border-color: var(--primary);">
                <h4 style="color:var(--primary); margin-top:0;"><i class="fas fa-users-cog"></i> FORO DE MEJORAS &
                    FEEDBACK</h4>
                <div style="font-size:0.8rem; color:#94a3b8; margin-bottom:10px;">
                    Ayúdanos a mejorar AutomaDrive. Tu opinión llega directa al equipo de ingeniería.
                </div>

                <div id="feedback-list"
                    style="max-height:150px; overflow-y:auto; margin-bottom:10px; padding:10px; background:#0d1117; border-radius:8px;">
                    <div
                        style="font-size:0.75rem; color:#94a3b8; border-bottom:1px dashed #333; padding-bottom:5px; margin-bottom:5px;">
                        <b style="color:var(--accent)">Taller Norte:</b> ¿Podrían añadir integración con WhatsApp
                        Business?
                    </div>
                    <div style="font-size:0.75rem; color:#94a3b8;">
                        <b style="color:var(--gold)">AutomaDrive:</b> ¡Anotado! Lo estamos evaluando para la v2.
                    </div>
                </div>

                <textarea id="feedback-input" rows="2" placeholder="Propón una mejora o reporta un fallo..."
                    style="width:100%; margin-bottom:5px; background:#0d1117; color:white; border:1px solid #30363d;"></textarea>
                <button class="mini-btn" style="width:100%; background:var(--primary); color:#000;"
                    onclick="submitFeedback()">
                    <i class="fas fa-paper-plane"></i> ENVIAR SUGERENCIA
                </button>
            </div>
        </div>

        <div class="side-col">
            <div class="ad-box">
                <i class="fas fa-gas-pump" style="color:var(--gold);"></i> <b>CASTROL PRO</b>
                <button onclick="pedidoRapido()"
                    style="width:100%; margin-top:10px; background:var(--gold); border:none; padding:10px; border-radius:8px; font-weight:bold; cursor:pointer;">PEDIDO
                    R&Aacute;PIDO</button>
            </div>

            <div class="internal-comm" style="border-color:#635bff;">
                <h4 style="color:#a5b4fc; margin-top:0;"><i class="fas fa-gem"></i> PLANES PRO</h4>
                <div style="font-size:0.75rem; color:#94a3b8; margin-bottom:10px;">Potencia tu taller hoy.</div>

                <!-- STARTER -->
                <div style="border:1px solid #30363d; border-radius:8px; padding:10px; margin-bottom:8px;">
                    <div style="display:flex; justify-content:space-between; align-items:center;">
                        <b style="color:#fff;">STARTER</b>
                        <span class="badge">49€/mes</span>
                    </div>
                    <div class="partner-small" style="margin:5px 0;">Gestión básica + Check-in.</div>
                    <ul class="partner-small" style="list-style:none; padding:0; margin:8px 0;">
                        <li><i class="fas fa-check" style="color:#94a3b8; margin-right:5px; width:15px;"></i>Recepción /
                            Check-in rápido</li>
                        <li><i class="fas fa-check" style="color:#94a3b8; margin-right:5px; width:15px;"></i>Orden de
                            trabajo (OT) básica</li>
                        <li><i class="fas fa-check" style="color:#94a3b8; margin-right:5px; width:15px;"></i>Historial y
                            recordatorios</li>
                        <li><i class="fas fa-check" style="color:#94a3b8; margin-right:5px; width:15px;"></i>Evidencias
                            básicas</li>
                    </ul>
                    <div style="display:flex; gap:5px;">
                        <button class="mini-btn" style="flex:1;" onclick="openSignup('starter')">Probar</button>
                        <button class="mini-btn" style="flex:1; border-color:#635bff; color:#a5b4fc;"
                            onclick="startCheckout('starter')">Suscribir</button>
                    </div>
                </div>

                <!-- PRO -->
                <div
                    style="border:1px solid #4ade80; background:rgba(74,222,128,0.05); border-radius:8px; padding:10px; margin-bottom:8px;">
                    <div style="display:flex; justify-content:space-between; align-items:center;">
                        <b style="color:#4ade80;">PRO</b>
                        <span class="badge" style="border-color:#4ade80; color:#4ade80;">79€/mes</span>
                    </div>
                    <div class="partner-small" style="margin:5px 0;">IA Diagnóstico + Veri*Factu.</div>
                    <div class="partner-small"
                        style="color:var(--primary); font-weight:800; margin-bottom:4px; font-size:0.7rem;">🔥 Más
                        vendido</div>
                    <ul class="partner-small" style="list-style:none; padding:0; margin:8px 0;">
                        <li><i class="fas fa-robot" style="color:var(--primary); margin-right:5px; width:15px;"></i>IA
                            experta en diagnóstico</li>
                        <li><i class="fas fa-headset"
                                style="color:var(--primary); margin-right:5px; width:15px;"></i>Manos libres +
                            Centralita IA</li>
                        <li><i class="fas fa-microphone"
                                style="color:var(--primary); margin-right:5px; width:15px;"></i>Grabadora de incidencias
                        </li>
                        <li><i class="fas fa-file-invoice-dollar"
                                style="color:var(--primary); margin-right:5px; width:15px;"></i>Facturación + Veri*Factu
                        </li>
                        <li><i class="fas fa-comment-dots"
                                style="color:var(--primary); margin-right:5px; width:15px;"></i>Plantillas rápidas</li>
                    </ul>
                    <div style="display:flex; gap:5px;">
                        <button class="mini-btn" style="flex:1;" onclick="openSignup('pro')">Demo</button>
                        <button class="mini-btn" style="flex:1; background:#4ade80; color:#000; border:none;"
                            onclick="startCheckout('pro')">Suscribir</button>
                    </div>
                </div>

                <!-- ELITE -->
                <div style="border:1px solid var(--gold); border-radius:8px; padding:10px;">
                    <div style="display:flex; justify-content:space-between; align-items:center;">
                        <b style="color:var(--gold);">ELITE</b>
                        <span class="badge" style="border-color:var(--gold); color:var(--gold);">129€/mes</span>
                    </div>
                    <div class="partner-small" style="margin:5px 0;">Todo incluido + Soporte 24h.</div>
                    <div class="partner-small"
                        style="color:var(--gold); font-weight:800; margin-bottom:4px; font-size:0.7rem;">⭐ Recomendado
                        talleres top</div>
                    <ul class="partner-small" style="list-style:none; padding:0; margin:8px 0;">
                        <li><i class="fas fa-check-double"
                                style="color:var(--gold); margin-right:5px; width:15px;"></i>TODO lo anterior
                            (Starter+Pro)</li>
                        <li><i class="fas fa-video" style="color:var(--gold); margin-right:5px; width:15px;"></i>Video
                            Foso (monitor cámaras)</li>
                        <li><i class="fas fa-phone-volume"
                                style="color:var(--gold); margin-right:5px; width:15px;"></i>Centralita ELITE (nº
                            propio)</li>
                        <li><i class="fas fa-fingerprint"
                                style="color:var(--gold); margin-right:5px; width:15px;"></i>Evidencias avanzadas + Hash
                        </li>
                        <li><i class="fas fa-user-shield"
                                style="color:var(--gold); margin-right:5px; width:15px;"></i>Soporte prioritario 24h
                        </li>
                    </ul>
                    <div style="display:flex; gap:5px;">
                        <button class="mini-btn" style="flex:1;" onclick="openSignup('elite')">Demo</button>
                        <button class="mini-btn" style="flex:1; border-color:var(--gold); color:var(--gold);"
                            onclick="startCheckout('elite')">Suscribir</button>
                    </div>
                </div>
            </div>

            <div class="internal-comm partner-card">
                <div class="partner-title">
                    <div style="display:flex; align-items:center; gap:10px;">
                        <i class="fas fa-flag-checkered" style="color:var(--gold);"></i>
                        <div style="font-weight:900; color: var(--gold);">RACE</div>
                    </div>
                    <span class="badge"><i class="fas fa-crown" style="color:var(--gold);"></i> PARTNER OFICIAL</span>
                </div>
                <div class="partner-small">
                    Asistencia en carretera 24/7 &middot; Cobertura nacional &middot; Soporte premium para taller.
                    <div style="margin-top:6px; font-size:0.72rem; color:#94a3b8;">
                        *Espacio reservado para colaboraci&oacute;n (logo oficial tras autorizaci&oacute;n).
                    </div>
                </div>
                <button class="cta" onclick="window.open('https://www.race.es/', '_blank')">
                    Ver cobertura / Propuesta
                </button>
            </div>

            <div class="internal-comm">
                <h4 style="color:var(--gold); margin-top:0;"><i class="fas fa-bullhorn"></i> MARCAS EXCLUSIVAS</h4>

                <div class="partner-rotator">
                    <div class="partner-row">
                        <div class="partner-name" id="partner-name">—</div>
                        <span class="badge" id="partner-tag">Motor</span>
                    </div>
                    <div class="partner-desc" id="partner-desc">Cargando banner...</div>
                    <button class="mini-btn" style="margin-top:10px; width:100%;" id="partner-cta"
                        onclick="partnerClick()">Ver</button>
                </div>

                <div style="margin-top:8px; font-size:0.72rem; color:#94a3b8;">
                    Rotaci&oacute;n autom&aacute;tica (productos/servicios del motor).
                </div>
            </div>

            <!-- ✅ NUEVO: MENSAJERÍA INTERNA (móvil/tablet ↔ PC) -->
            <div id="msg-box" class="internal-comm" style="border-color: var(--accent);">
                <h4 style="color:var(--accent); margin-top:0;"><i class="fas fa-message"></i> MENSAJER&Iacute;A INTERNA
                </h4>

                <div style="font-size:0.78rem; color:#94a3b8; margin-bottom:10px;">
                    Chat interno para coordinar taller ↔ oficina. Funciona en PC y m&oacute;vil/tablet contra tu
                    servidor (Raspberry/VPS).
                </div>

                <div style="display:flex; gap:8px; flex-wrap:wrap; margin-bottom:10px;">
                    <span class="role-pill" id="role-taller" onclick="setMsgRole('taller')"><i
                            class="fas fa-wrench"></i> Taller</span>
                    <span class="role-pill" id="role-oficina" onclick="setMsgRole('oficina')"><i
                            class="fas fa-building"></i> Oficina</span>
                </div>

                <div id="msg-list" class="msg-list">
                    <div style="color:#94a3b8;">Conectando...</div>
                </div>

                <div class="msg-tools">
                    <input id="msg-input" type="text" placeholder="Escribe un mensaje..." style="margin:0;">
                    <button class="mini-btn" onclick="msgSend()"><i class="fas fa-paper-plane"></i> Enviar</button>
                    <button class="mini-btn" onclick="msgForceRefresh()"><i class="fas fa-rotate"></i>
                        Refrescar</button>
                </div>

                <div id="msg-status" class="muted" style="margin-top:8px; font-size:0.72rem;">&nbsp;</div>
            </div>

            <div class="internal-comm" style="border-color: var(--primary);">
                <h4 style="color:var(--primary); margin-top:0;">
                    <i class="fas fa-rotate"></i> HISTORIAL INTELIGENTE
                </h4>
                <div style="font-size:0.78rem; color:#94a3b8; margin-bottom:10px;">
                    Detecta patrones y crea recordatorios (ITV/aceite/frenos/distribuci&oacute;n) en base a actividad y
                    notas.
                </div>
                <div style="display:flex; gap:8px; flex-wrap:wrap; margin-bottom:10px;">
                    <button class="mini-btn" onclick="smartRefresh()">Actualizar</button>
                    <button class="mini-btn" onclick="smartCopy()">Copiar</button>
                </div>
                <div id="smart-box"
                    style="background:#0d1117; border:1px solid #30363d; border-radius:10px; padding:10px; font-size:0.8rem; color:#e6edf3; max-height:180px; overflow:auto;">
                    <div style="color:#94a3b8;">Pulsa <b>Actualizar</b> para ver recomendaciones.</div>
                </div>
            </div>

            <div class="internal-comm" style="border-color: var(--gold);">
                <h4 style="color:var(--gold); margin-top:0;">
                    <i class="fas fa-shield-halved"></i> EVIDENCIAS (ANTI-RECLAMACIONES)
                </h4>
                <div style="font-size:0.78rem; color:#94a3b8; margin-bottom:10px;">
                    Cada captura queda registrada con sello de hora + hash (y geo opcional).
                </div>
                <div style="display:flex; gap:8px; flex-wrap:wrap; margin-bottom:10px;">
                    <button class="mini-btn" onclick="eviCopy()">Copiar parte</button>
                    <button class="mini-btn" onclick="eviClear()">Limpiar</button>
                </div>
                <div id="evi-box"
                    style="background:#0d1117; border:1px solid #30363d; border-radius:10px; padding:10px; font-size:0.78rem; color:#e6edf3; max-height:180px; overflow:auto;">
                    <div style="color:#94a3b8;">A&uacute;n no hay evidencias en esta sesi&oacute;n.</div>
                </div>
            </div>

            <div class="internal-comm" style="border-color:var(--accent);">
                <h4 style="color:var(--accent); margin-top:0;"><i class="fas fa-truck"></i> PROVEEDORES 24/7</h4>
                <button onclick="window.open('https://www.distriauto.es')"
                    style="width:100%; background:#fff; color:#000; border:none; padding:10px; border-radius:8px; font-weight:bold; cursor:pointer; margin-bottom:10px;">DISTRIAUTO</button>
                <button onclick="window.open('https://www.autodoc.es')"
                    style="width:100%; background:#ffdb00; color:#000; border:none; padding:10px; border-radius:8px; font-weight:bold; cursor:pointer;">AUTODOC</button>
            </div>

            <!-- ✅ 3) FACTURACIÓN + VERI*FACTU (MOVIDO AQUÍ) -->
            <div class="ai-assistant" style="border-color: var(--gold);">
                <div
                    style="display:flex; align-items:center; justify-content:space-between; gap:10px; margin-bottom:10px;">
                    <div style="color:var(--gold); font-weight:900;">
                        <i class="fas fa-receipt"></i> FACTURACI&Oacute;N + VERI*FACTU
                    </div>
                    <span class="badge">AEAT-ready</span>
                </div>

                <div class="small-help">
                    Emite factura desde la OT.
                </div>

                <div
                    style="background:rgba(227, 179, 65, 0.1); border-left:3px solid var(--gold); padding:8px; font-size:0.7rem; color:#e6edf3; margin-bottom:10px;">
                    ℹ️ <b>Sistema Veri*Factu:</b> La conexión con Hacienda será obligatoria. Tus facturas generarán
                    huella digital.
                </div>

                <div class="form-grid">
                    <input id="vf_serie" type="text" placeholder="Serie (A)"
                        style="text-transform:uppercase; font-weight:900;">
                    <input id="vf_num" type="text" placeholder="Nº (auto)">
                    <select id="vf_tipo">
                        <option value="normal">Normal</option>
                        <option value="rectificativa">Rectificativa</option>
                    </select>
                    <select id="vf_iva">
                        <option value="21">21%</option>
                        <option value="10">10%</option>
                        <option value="4">4%</option>
                        <option value="0">0%</option>
                    </select>

                    <input class="full" id="vf_concepto" type="text" placeholder="Concepto">
                    <input id="vf_base" type="number" step="0.01" placeholder="Base €">
                    <input id="vf_total" type="number" step="0.01" placeholder="Total €">

                    <div class="full" style="display:flex; align-items:center; gap:8px; margin-bottom:5px;">
                        <input type="checkbox" id="vf_auto" checked style="width:auto; margin:0;">
                        <label for="vf_auto" style="font-size:0.75rem; color:#94a3b8; cursor:pointer;">Auto-conectar
                            Veri*Factu</label>
                    </div>

                    <div class="full" style="display:flex; gap:8px; flex-wrap:wrap;">
                        <button class="mini-btn" onclick="vfFromOT()"><i class="fas fa-link"></i> OT</button>
                        <button class="mini-btn" onclick="vfCalc()"><i class="fas fa-calculator"></i> Calc</button>
                        <button class="mini-btn" style="border-color:var(--gold);" onclick="vfEmit()"><i
                                class="fas fa-cloud-arrow-up"></i> Emitir</button>
                    </div>

                    <div id="vf_status" class="muted full" style="font-size:0.72rem;">&nbsp;</div>
                </div>
            </div>


            <div class="internal-comm">
                <h4 style="color:var(--primary); margin-top:0;"><i class="fas fa-comments"></i> COMUNICACI&Oacute;N</h4>
                <button onclick="abrirWhatsApp()"
                    style="width:100%; background:#25D366; color:white; border:none; padding:10px; border-radius:8px; margin-bottom:10px; font-weight:bold; cursor:pointer;">
                    <i class="fab fa-whatsapp"></i> WHATSAPP BUSINESS
                </button>
                <button onclick="abrirTelegram()"
                    style="width:100%; background:#0088cc; color:white; border:none; padding:10px; border-radius:8px; margin-bottom:10px; cursor:pointer;"><i
                        class="fab fa-telegram-plane"></i> TELEGRAM</button>
                <button onclick="abrirVideoFoso()"
                    style="width:100%; background:#28a745; color:white; border:none; padding:10px; border-radius:8px;"><i
                        class="fas fa-video"></i> VIDEO FOSO</button>
            </div>

            <!-- ✅ 5) Grabadora de voz anti-clientes faltosos (con hash + evidencia) -->
            <div id="rec-box" class="ai-assistant" style="border-color:#ff6b6b;">
                <div
                    style="display:flex; align-items:center; justify-content:space-between; gap:10px; margin-bottom:10px;">
                    <div style="color:#ff6b6b; font-weight:900;">
                        <i class="fas fa-microphone"></i> GRABADORA (INCIDENCIAS / CLIENTES FALTOSOS)
                    </div>
                    <span class="badge">Hash + Evidencia</span>
                </div>

                <div class="small-help">
                    Graba una conversaci&oacute;n/amenaza/insulto como <b>evidencia</b> (solo si es legal en tu
                    jurisdicci&oacute;n).
                    Se registra en <b>EVIDENCIAS</b> con hash y fecha.
                </div>

                <div class="rec-row">
                    <button id="recStart" class="rec-btn rec-start" onclick="recStart()"><i class="fas fa-circle"></i>
                        Grabar</button>
                    <button id="recStop" class="rec-btn rec-stop" onclick="recStop()" disabled><i
                            class="fas fa-stop"></i> Parar</button>
                    <button id="recSave" class="rec-btn rec-save" onclick="recSave()" disabled><i
                            class="fas fa-file-arrow-down"></i> Guardar</button>
                </div>

                <div id="recStatus" class="muted" style="margin-top:10px; font-size:0.72rem;">&nbsp;</div>

                <div class="result-box" style="margin-top:10px;">
                    <div class="sec">Grabaciones de esta sesi&oacute;n</div>
                    <div id="audioList" class="audio-list">
                        <div class="muted">A&uacute;n no hay grabaciones.</div>
                    </div>
                </div>
            </div>
        </div>
    </div>



    <footer>
        AutomaDrive Pro &copy; 2025 | Soporte: <a href="/cdn-cgi/l/email-protection" class="__cf_email__"
            data-cfemail="cca5a2aaa3e2adb9b8a3a1ada8bea5baa9bcbea38caba1ada5a0e2afa3a1">[email&#160;protected]</a> | ID:
        RASP-PRO-01 | <a href="#" style="color:#666;">Privacidad</a>
    </footer>

    <div id="miModal" class="modal">
        <div class="modal-content">
            <h2 style="color:var(--primary); margin-top:0;">EXPEDIENTE T&Eacute;CNICO</h2>
            <label>MATR&Iacute;CULA</label>
            <input type="text" id="matricula" placeholder="1234ABC" style="text-transform:uppercase; font-weight:bold;">
            <label>CLIENTE</label>
            <input type="text" id="propietario" placeholder="Nombre completo">
            <label>WHATSAPP</label>
            <input type="text" id="telefono" placeholder="+34 744456978">
            <label>NOTAS</label>
            <textarea id="notes" rows="4" placeholder="Diagn&oacute;stico..."></textarea>
            <div style="display:flex; gap:10px;">
                <button onclick="cerrarModal()"
                    style="background:#e74c3c; color:white; border:none; padding:12px; border-radius:8px; flex:1; cursor:pointer; font-weight:bold;">CANCELAR</button>
                <button id="btn-guardar" onclick="guardarFicha()"
                    style="background:var(--primary); color:#000; border:none; padding:12px; border-radius:8px; flex:2; cursor:pointer; font-weight:bold;">
                    <i class="fas fa-save"></i> GUARDAR Y AVISAR
                </button>
            </div>
        </div>
    </div>

    <div id="lockOverlay" class="lock-overlay">
        <div class="lock-card">
            <div class="lock-title">
                <h3><i class="fas fa-shield-halved"></i> Acceso protegido</h3>
                <span class="small-pill" id="lockModePill">Doble verificación</span>
            </div>

            <p class="lock-sub">
                Para usar el panel necesitas <b>email</b> (suscripción) y acceso seguro (<b>PIN + Patrón</b>).
            </p>

            <div class="lock-row">
                <div>
                    <div class="lock-mini"><i class="fas fa-envelope"></i> Email del cliente (suscripción)</div>
                    <input id="lockEmail" class="lock-input" type="email" placeholder="taller@correo.com"
                        autocomplete="email">
                    <div class="lock-hint">Este email se enviará en cada petición (gating).</div>
                </div>

                <div>
                    <div class="lock-mini"><i class="fas fa-key"></i> PIN (4-8 dígitos)</div>
                    <input id="lockPin" class="lock-input" type="password" inputmode="numeric" placeholder="••••"
                        autocomplete="off" maxlength="8">
                    <div class="lock-hint">Si es la primera vez, se guardará como PIN del dispositivo.</div>
                </div>
            </div>

            <div style="margin-top:12px;">
                <div class="lock-mini"><i class="fas fa-hand-pointer"></i> Patrón (dibuja con el dedo o ratón)</div>
                <div class="pattern-wrap">
                    <div id="patternGrid" class="pattern-grid">
                        <div class="dot" data-dot="1"></div>
                        <div class="dot" data-dot="2"></div>
                        <div class="dot" data-dot="3"></div>
                        <div class="dot" data-dot="4"></div>
                        <div class="dot" data-dot="5"></div>
                        <div class="dot" data-dot="6"></div>
                        <div class="dot" data-dot="7"></div>
                        <div class="dot" data-dot="8"></div>
                        <div class="dot" data-dot="9"></div>
                    </div>
                    <div class="pattern-preview" id="patternPreview">Patrón: (vacío)</div>
                </div>
            </div>

            <div class="lock-error" id="lockError">Error</div>

            <div class="lock-actions">
                <button class="lock-btn primary" onclick="unlockNow()">
                    <i class="fas fa-unlock"></i> ENTRAR
                </button>
                <button class="lock-btn" onclick="resetLocalLock()">
                    <i class="fas fa-rotate-left"></i> Reset acceso
                </button>
                <button class="lock-btn danger" onclick="window.location.reload()">
                    <i class="fas fa-power-off"></i> Reiniciar
                </button>
            </div>

            <div class="lock-hint">
                ? Modo móvil: bloqueo recomendado. En PC también funciona si lo activas.
            </div>
        </div>
    </div>

    <div id="signupModal" class="modal">
        <div class="modal-content">
            <h2 style="color:var(--primary); margin-top:0;">ALTA TALLER <span id="signupPlanBadge" class="badge"></span>
            </h2>
            <div class="small-help">Completa los datos para activar tu cuenta o solicitar demo.</div>

            <label>NOMBRE DEL TALLER</label>
            <input type="text" id="lead_taller" placeholder="Ej: Talleres Pepe">

            <label>PERSONA DE CONTACTO</label>
            <input type="text" id="lead_contacto" placeholder="Tu nombre">

            <label>TELÉFONO / WHATSAPP</label>
            <input type="text" id="lead_tel" placeholder="+34 ...">

            <label>EMAIL (CUENTA)</label>
            <input type="email" id="lead_email" placeholder="admin@taller.com">

            <label>COMENTARIOS (OPCIONAL)</label>
            <textarea id="lead_notas" rows="2" placeholder="¿Dudas?"></textarea>

            <div style="display:flex; gap:10px; margin-top:15px;">
                <button onclick="closeSignup()"
                    style="background:#30363d; color:white; border:none; padding:12px; border-radius:8px; flex:1; cursor:pointer; font-weight:bold;">CANCELAR</button>
                <button onclick="submitLead(false)"
                    style="background:transparent; border:1px solid var(--primary); color:white; padding:12px; border-radius:8px; flex:1; cursor:pointer; font-weight:bold;">PEDIR
                    DEMO</button>
                <button onclick="submitLead(true)"
                    style="background:var(--primary); color:#000; border:none; padding:12px; border-radius:8px; flex:2; cursor:pointer; font-weight:bold;">
                    <i class="fas fa-credit-card"></i> IR A PAGO
                </button>
            </div>
        </div>
    </div>

    <!-- ✅ VIDEO MODAL (AUTO-DETECT) -->
    <div id="videoModal" class="modal" style="display:none; align-items:center; justify-content:center;">
        <div class="modal-content" style="width:800px; max-width:95vw; background:#0d1117; border:1px solid #30363d;">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                <h2 style="color:var(--primary); margin:0;">📡 MONITOR DE CÁMARAS</h2>
                <button onclick="closeVideoModal()"
                    style="background:none; border:none; color:#fff; font-size:1.5rem; cursor:pointer;">&times;</button>
            </div>

            <div style="display:flex; flex-direction:column; gap:10px;">
                <select id="camSelector" class="lock-input"
                    style="font-weight:bold; color:var(--accent); margin-bottom:0;"
                    onchange="switchCamera(this.value)"></select>

                <div
                    style="position:relative; width:100%; height:450px; background:#000; border-radius:8px; overflow:hidden; border:1px solid #30363d;">
                    <video id="liveFeed" autoplay playsinline
                        style="width:100%; height:100%; object-fit:contain;"></video>
                    <div
                        style="position:absolute; bottom:10px; left:10px; right:10px; display:flex; justify-content:center; pointer-events:none;">
                        <span
                            style="background:rgba(0,0,0,0.6); color:#fff; padding:4px 8px; border-radius:4px; font-size:0.8rem;">
                            Detectando dispositivos locales + red...
                        </span>
                    </div>
                    <button onclick="toggleFullscreen()"
                        style="position:absolute; bottom:10px; right:10px; background:rgba(0,0,0,0.7); color:#fff; border:none; border-radius:4px; padding:5px 10px; cursor:pointer; font-size:1.2rem; pointer-events:auto;"
                        title="Pantalla Completa">
                        <i class="fas fa-expand"></i>
                    </button>
                </div>

                <div style="display:flex; gap:10px; margin-top:5px;">
                    <button onclick="addIpCam()" class="mini-btn"
                        style="flex:1; border-color:var(--gold); color:var(--gold);">➕ Añadir Cámara IP / WiFi</button>
                    <button onclick="detectCameras()" class="mini-btn" style="flex:1;">🔄 Re-Escanear</button>
                </div>
            </div>
        </div>
    </div>

    <script data-cfasync="false" src="/cdn-cgi/scripts/5c5dd728/cloudflare-static/email-decode.min.js"></script>
    <script>
        /* ==========================================================
           ✅ GATING + DOBLE SEGURIDAD (PIN + PATRÓN)
           ========================================================== */
        const ADP_EMAIL_KEY = "adp_customer_email_v1";
        const ADP_PIN_HASH_KEY = "adp_pin_hash_v1";
        const ADP_PATTERN_HASH_KEY = "adp_pattern_hash_v1";
        const ADP_LOCK_ENABLED_KEY = "adp_lock_enabled_v1";

        const getEl = (id) => document.getElementById(id);

        function setCookie(name, value, days = 30) {
            const d = new Date();
            d.setTime(d.getTime() + (days * 24 * 60 * 60 * 1000));
            document.cookie = `${name}=${encodeURIComponent(value)}; expires=${d.toUTCString()}; path=/; SameSite=Lax`;
        }

        function getSavedEmail() { return (localStorage.getItem(ADP_EMAIL_KEY) || "").trim(); }

        function setSavedEmail(email) {
            localStorage.setItem(ADP_EMAIL_KEY, email);
            setCookie("adp_email", email, 30);
        }

        async function sha256Hex(text) {
            const enc = new TextEncoder().encode(text);
            const buf = await crypto.subtle.digest("SHA-256", enc);
            return [...new Uint8Array(buf)].map(b => b.toString(16).padStart(2, "0")).join("");
        }

        async function sha256BlobHex(blob) {
            const ab = await blob.arrayBuffer();
            const buf = await crypto.subtle.digest("SHA-256", ab);
            return [...new Uint8Array(buf)].map(b => b.toString(16).padStart(2, "0")).join("");
        }

        async function apiFetch(url, options = {}) {
            const email = getSavedEmail();
            const opts = { ...options };
            opts.headers = { ...(opts.headers || {}) };

            if (email) {
                opts.headers["X-Customer-Email"] = email;
                setCookie("adp_email", email, 30);
            }

            if ((!opts.method || opts.method.toUpperCase() === "GET") && email) {
                try {
                    const u = new URL(url, window.location.origin);
                    if (!u.searchParams.get("email")) u.searchParams.set("email", email);
                    url = u.pathname + u.search;
                } catch (e) { }
            }

            return fetch(url, opts);
        }

        let __patternCurrent = [];
        let __patternIsDrawing = false;

        function isMobileLike() { return window.matchMedia("(max-width: 820px)").matches; }

        function lockEnabled() {
            const v = localStorage.getItem(ADP_LOCK_ENABLED_KEY);
            if (v === "0") return false;
            if (v === "1") return true;
            return isMobileLike();
        }

        function showLock() {
            const ov = getEl("lockOverlay");
            if (!ov) return;
            ov.style.display = "flex";

            const email = getSavedEmail();
            if (email) getEl("lockEmail").value = email;

            __patternCurrent = [];
            updatePatternPreview();
            document.querySelectorAll(".dot").forEach(d => d.classList.remove("active"));
        }

        function hideLock() {
            const ov = getEl("lockOverlay");
            if (!ov) return;
            ov.style.display = "none";
        }

        function updatePatternPreview() {
            const pv = getEl("patternPreview");
            if (!pv) return;
            pv.textContent = __patternCurrent.length ? `Patrón: ${__patternCurrent.join("-")}` : "Patrón: (vacío)";
        }

        function attachPatternEvents() {
            const grid = getEl("patternGrid");
            if (!grid) return;

            const activateDot = (dotEl) => {
                const n = dotEl?.dataset?.dot;
                if (!n) return;
                if (__patternCurrent.includes(n)) return;
                __patternCurrent.push(n);
                dotEl.classList.add("active");
                updatePatternPreview();
            };

            const onDown = (e) => {
                __patternIsDrawing = true;
                __patternCurrent = [];
                document.querySelectorAll(".dot").forEach(d => d.classList.remove("active"));
                updatePatternPreview();
                const target = e.target.closest(".dot");
                if (target) activateDot(target);
            };

            const onMove = (e) => {
                if (!__patternIsDrawing) return;
                const point = (e.touches && e.touches[0]) ? e.touches[0] : e;
                const el = document.elementFromPoint(point.clientX, point.clientY);
                const dot = el?.closest?.(".dot");
                if (dot) activateDot(dot);
            };

            const onUp = () => { __patternIsDrawing = false; };

            grid.addEventListener("mousedown", onDown);
            window.addEventListener("mousemove", onMove);
            window.addEventListener("mouseup", onUp);

            grid.addEventListener("touchstart", onDown, { passive: true });
            window.addEventListener("touchmove", onMove, { passive: true });
            window.addEventListener("touchend", onUp, { passive: true });
        }

        function lockError(msg) {
            const el = getEl("lockError");
            if (!el) return;
            el.textContent = msg;
            el.style.display = "block";
            setTimeout(() => { el.style.display = "none"; }, 2500);
        }

        async function unlockNow() {
            const email = (getEl("lockEmail").value || "").trim().toLowerCase();
            const pin = (getEl("lockPin").value || "").trim();
            const pattern = __patternCurrent.join("");

            if (!email || !email.includes("@")) return lockError("Introduce un email válido.");
            if (pin.length < 4) return lockError("PIN mínimo 4 dígitos.");
            if (pattern.length < 4) return lockError("Patrón mínimo 4 puntos.");

            setSavedEmail(email);

            const pinHash = await sha256Hex("PIN:" + pin);
            const patHash = await sha256Hex("PAT:" + pattern);

            const savedPin = localStorage.getItem(ADP_PIN_HASH_KEY);
            const savedPat = localStorage.getItem(ADP_PATTERN_HASH_KEY);

            if (!savedPin || !savedPat) {
                localStorage.setItem(ADP_PIN_HASH_KEY, pinHash);
                localStorage.setItem(ADP_PATTERN_HASH_KEY, patHash);
                localStorage.setItem(ADP_LOCK_ENABLED_KEY, "1");
                hideLock();
                return;
            }

            if (pinHash !== savedPin) return lockError("PIN incorrecto.");
            if (patHash !== savedPat) return lockError("Patrón incorrecto.");

            hideLock();
        }

        function resetLocalLock() {
            if (!confirm("¿Resetear PIN, patrón y email guardados en este dispositivo?")) return;
            localStorage.removeItem(ADP_EMAIL_KEY);
            localStorage.removeItem(ADP_PIN_HASH_KEY);
            localStorage.removeItem(ADP_PATTERN_HASH_KEY);
            localStorage.removeItem(ADP_LOCK_ENABLED_KEY);
            setCookie("adp_email", "", -1);
            alert("? Reset hecho. Recarga la página.");
        }

        document.addEventListener("DOMContentLoaded", () => {
            attachPatternEvents();
            if (lockEnabled()) {
                showLock();
            } else {
                const em = getSavedEmail();
                if (em) setCookie("adp_email", em, 30);
            }
        });

        // =========================================
        // UTIL (tuya)
        // =========================================
        const $ = (id) => document.getElementById(id);
        const EVI_KEY = "automadrive_evidencias_session_v1";
        let diagState = null;
        let diagClientText = "";

        // =========================================
        // RELOJ
        // =========================================
        function startClock() {
            const el = $('reloj-maestro') || $('master-clock'); // Compatibilidad con ambos IDs
            if (!el) return;
            const tick = () => {
                const d = new Date();
                const hh = String(d.getHours()).padStart(2, '0');
                const mm = String(d.getMinutes()).padStart(2, '0');
                const ss = String(d.getSeconds()).padStart(2, '0');
                el.textContent = `${hh}:${mm}:${ss}`;
            };
            tick();
            setInterval(tick, 1000);
        }

        // =========================================
        // CENTRALITA IA AVANZADA - REAL MODE (AUTOMADRIVE)
        // =========================================
        let cState = 'idle';
        let cTimer = null;
        let cVolume = 0.8;
        let cCurrentCaller = null;
        let cIsListening = false;

        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        let recognition = null;
        let audioCtx = null;
        let analyser = null;
        let microphone = null;
        let dataArray = null;
        let animationId = null;

        // --- REAL VOIP & P2P SYNC ---
        let peer = null;
        let currentPeerCall = null;
        let myPeerId = null;
        let sipUA = null;
        let remoteStream = null;
        let activeDevices = []; // Para ver quién está online

        const CONTACTS_KEY = "automadrive_contacts_v1";

        const C_CALLERS = [
            { name: "MÓVIL PROPIETARIO", phone: "+34 744 403 191" },
            { name: "SOPORTE TÉCNICO", phone: "+34 900 000 000" },
            { name: "EMERGENCIAS 112", phone: "112" }
        ];

        function getStoredContacts() {
            const c = localStorage.getItem(CONTACTS_KEY);
            return c ? JSON.parse(c) : [];
        }

        function saveStoredContact(name, phone) {
            const contacts = getStoredContacts();
            if (!contacts.find(x => x.phone === phone)) {
                contacts.push({ name: name, phone: phone });
                localStorage.setItem(CONTACTS_KEY, JSON.stringify(contacts));
            }
        }

        let cToneOsc1 = null;
        let cToneOsc2 = null;
        let cToneGain = null;

        function cPlayTone(freq1, freq2, volMod = 0.05) {
            if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            if (audioCtx.state === 'suspended') audioCtx.resume();
            cStopTone();
            cToneOsc1 = audioCtx.createOscillator();
            cToneOsc1.frequency.setValueAtTime(freq1, audioCtx.currentTime);
            if (freq2) {
                cToneOsc2 = audioCtx.createOscillator();
                cToneOsc2.frequency.setValueAtTime(freq2, audioCtx.currentTime);
            }
            cToneGain = audioCtx.createGain();
            cToneGain.gain.setValueAtTime(cVolume * volMod, audioCtx.currentTime);
            cToneOsc1.connect(cToneGain);
            if (cToneOsc2) cToneOsc2.connect(cToneGain);
            cToneGain.connect(audioCtx.destination);
            cToneOsc1.start();
            if (cToneOsc2) cToneOsc2.start();
        }

        function cStopTone() {
            if (cToneOsc1) { try { cToneOsc1.stop(); } catch (e) { } cToneOsc1 = null; }
            if (cToneOsc2) { try { cToneOsc2.stop(); } catch (e) { } cToneOsc2 = null; }
        }

        function initCentralitaAudio() {
            if (audioCtx) return;
            try {
                audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                analyser = audioCtx.createAnalyser();
                analyser.fftSize = 32;
                dataArray = new Uint8Array(analyser.frequencyBinCount);
                navigator.mediaDevices.getUserMedia({ audio: true }).then(stream => {
                    microphone = audioCtx.createMediaStreamSource(stream);
                    microphone.connect(analyser);
                    animateCentralitaEq();
                    initCentralitaSpeech();
                }).catch(err => {
                    console.error("Mic no disponible:", err);
                    alert("Por favor, permite el acceso al micrófono para usar la Centralita Real.");
                });
            } catch (e) { console.error("AudioContext error:", e); }
        }

        function animateCentralitaEq() {
            animationId = requestAnimationFrame(animateCentralitaEq);
            analyser.getByteFrequencyData(dataArray);
            const bars = document.querySelectorAll('#c-eq .eq-bar');
            dataArray.forEach((val, i) => {
                if (bars[i]) {
                    let h = 10 + (val / 255) * 45;
                    bars[i].style.height = h + 'px';
                    bars[i].style.opacity = 0.3 + (val / 255) * 0.7;
                }
            });
        }

        function initCentralitaSpeech() {
            if (!SpeechRecognition) return;
            recognition = new SpeechRecognition();
            recognition.continuous = true;
            recognition.lang = 'es-ES';
            recognition.onresult = (e) => {
                const text = e.results[e.results.length - 1][0].transcript.toLowerCase();
                console.log("IA escuchó:", text);
                if (text.includes("automa drive") || text.includes("automadrive")) {
                    if (cState === 'idle') cSimulateIncoming();
                }
                if (text.includes("llama a") || text.includes("llamar a")) {
                    const name = text.replace("llama a", "").replace("llamar a", "").trim();
                    cMakeVoiceCall(name);
                }
                if (cState === 'awaiting_mechanic') {
                    if (text.includes("pasa") || text.includes("atender") || text.includes("sí")) cMechanicAccept();
                    else if (text.includes("recado") || text.includes("no")) cIATakeMessage();
                }
            };
            recognition.onend = () => { if (cIsListening) recognition.start(); };
            cIsListening = true;
            recognition.start();
            $('c-btn-mic').classList.add('active');
            $('c-display-status').innerText = 'REAL: ESCUCHANDO "AUTOMADRIVE"...';
        }

        function cToggleListening() {
            if (!audioCtx) { initCentralitaAudio(); return; }
            cIsListening = !cIsListening;
            const btn = $('c-btn-mic');
            if (cIsListening) {
                btn.classList.add('active');
                if (recognition) recognition.start();
            } else {
                btn.classList.remove('active');
                if (recognition) recognition.stop();
            }
        }

        function cSetStatus(state, text) {
            cState = state;
            const dot = $('c-status-dot');
            dot.className = 'status-dot';
            if (state === 'ringing') dot.classList.add('ringing');
            if (state !== 'idle' && state !== 'ringing') dot.classList.add('active');
            $('c-display-status').innerText = text.toUpperCase();
        }

        function cTalking(isTalking) {
            if (isTalking) $('centralita-ui').classList.add('talking');
            else $('centralita-ui').classList.remove('talking');
        }

        function cSimulateIncoming() {
            if (cState !== 'idle' || !navigator.onLine) return;
            cCurrentCaller = C_CALLERS[Math.floor(Math.random() * C_CALLERS.length)];
            cSetStatus('ringing', 'LLAMADA ENTRANTE...');
            $('c-caller-id').innerText = cCurrentCaller.name;
            $('c-caller-id').style.color = 'var(--danger)';
            $('c-btn-hangup').disabled = false;
            cTimer = setTimeout(() => { if (cState === 'ringing') cIAStart(); }, 6000);
        }

        function cIAStart() {
            cSetStatus('ia_answering', 'IA ATENDIENDO...');
            $('c-caller-id').style.color = 'var(--accent)';
            cTalking(true);
            speakCentralita(`Bienvenido a AutomaDrive. Soy la asistente virtual. ¿Qué desea?`, () => {
                cTalking(false);
                setTimeout(() => {
                    cTalking(true);
                    speakCentralita(`Entendido. Le paso con el mecánico.`, () => {
                        cTalking(false);
                        cMechanicAccept();
                    });
                }, 1000);
            });
        }

        function cMechanicAccept() {
            cSetStatus('mechanic', 'HABLANDO...');
            cTalking(true);
            speakCentralita(`Llamada conectada en manos libres.`, () => cTalking(false));
        }

        function cIATakeMessage() {
            cSetStatus('recado', 'GRABANDO RECADO...');
            cTalking(true);
            speakCentralita(`Dígame su mensaje.`, () => {
                cTalking(false);
                setTimeout(() => { cAddToLog(cCurrentCaller.name, "Recado guardado."); cHangup(); }, 3000);
            });
        }

        function cHangup() {
            clearTimeout(cTimer);
            cStopTone();
            if (window.speechSynthesis) window.speechSynthesis.cancel();

            // Cerrar llamadas reales
            if (currentPeerCall) { currentPeerCall.close(); currentPeerCall = null; }
            if (remoteStream) { remoteStream.getTracks().forEach(t => t.stop()); remoteStream = null; }

            cTalking(false);
            cSetStatus('idle', 'ESCUCHANDO "AUTOMADRIVE"...');
            $('c-caller-id').innerText = "SISTEMA EN ESPERA";
            $('c-caller-id').style.color = "#fff";
            $('c-btn-hangup').disabled = true;

            // Log local
            if (cCurrentCaller) {
                cAddToLog(cCurrentCaller.name, "Llamada finalizada");
            }
        }

        function cAddToLog(name, type) {
            const list = $('c-log-list');
            if (!list) return;
            const empty = list.querySelector('.muted');
            if (empty) empty.remove();

            const item = document.createElement('div');
            item.className = 'log-item';
            item.innerHTML = `
                <div>
                    <b>${name}</b>
                    <span class="msg-badge">${type.includes('Recado') ? 'RECADO' : 'SISTEMA'}</span>
                </div>
                <div style="font-size:0.7rem; color:#666;">${new Date().toLocaleTimeString()}</div>
            `;
            list.prepend(item);
        }

        function speakCentralita(text, cb) {
            if (!window.speechSynthesis) return cb();
            window.speechSynthesis.cancel();
            const msg = new SpeechSynthesisUtterance(text);
            msg.lang = 'es-ES';
            msg.volume = cVolume;
            msg.onstart = () => cTalking(true);
            msg.onend = () => {
                cTalking(false);
                if (cb) cb();
            };
            window.speechSynthesis.speak(msg);
        }

        function toggleVolSlider() {
            const v = $('c-vol-wrap');
            if (v) v.style.display = (v.style.display === 'flex') ? 'none' : 'flex';
        }

        function cSetVolume(v) {
            cVolume = v / 100;
            if (window.speechSynthesis) {
                // Actualizar volumen si está hablando (no cancela, solo ajusta siguiente)
            }
        }

        function cOpenDialer() { $('c-dialer-overlay').style.display = 'flex'; }
        function cCloseDialer() { $('c-dialer-overlay').style.display = 'none'; }
        function cOpenAgenda() { $('c-agenda-overlay').style.display = 'flex'; cUpdateAgendaUI(); }
        function cCloseAgenda() { $('c-agenda-overlay').style.display = 'none'; }
        function cDialAdd(n) { $('c-dial-input').value += n; }

        function cUpdateAgendaUI() {
            const list = $('c-agenda-list');
            if (!list) return;
            list.innerHTML = '';

            // Combinar fijos, locales y otros dispositivos
            const all = [...C_CALLERS, ...getStoredContacts()];

            // Añadir mis otros dispositivos si están detectados
            if (peer && myPeerId) {
                const otherType = myPeerId.startsWith('pc_') ? 'mob_' : 'pc_';
                const otherId = otherType + myPeerId.split('_').slice(1).join('_');
                all.unshift({ name: "📱 MI OTRO DISPOSITIVO", phone: otherId, isPeer: true });
            }

            all.forEach(c => {
                const div = document.createElement('div');
                div.className = 'agenda-item';
                div.onclick = () => cMakeCallTo(c);
                div.innerHTML = `
                    <b>${c.name}</b>
                    <span style="font-size:0.8rem; color:${c.isPeer ? 'var(--accent)' : 'var(--primary)'};">
                        ${c.phone}
                    </span>
                `;
                list.appendChild(div);
            });
        }

        function cMakeManualCall() {
            const n = $('c-dial-input').value;
            if (n) cMakeCallTo({ name: n, phone: n });
            else alert("Introduce un número válido");
        }

        function cMakeCallTo(contact) {
            if (cState !== 'idle') return;
            if (!navigator.onLine) {
                alert("ERROR DE RED: No se puede iniciar la llamada sin conexión.");
                return;
            }
            cCloseDialer(); cCloseAgenda();
            cCurrentCaller = contact;
            cSetStatus('outbound', 'ESTABLECIENDO CONEXIÓN...');
            $('c-caller-id').innerText = contact.name;
            $('c-caller-id').style.color = 'var(--primary)';
            $('c-btn-hangup').disabled = false;

            // --- LÓGICA DE LLAMADA REAL ---
            const isPhoneNumber = /^[+0-9\s]+$/.test(contact.phone.replace(/\s/g, ''));

            if (isPhoneNumber && !contact.isPeer) {
                // LLAMADA A TELÉFONO REAL (PSTN)
                cPlayTone(350, 440, 0.02);
                cTimer = setTimeout(() => {
                    if (cState === 'idle') return; // Cancelado por usuario
                    cStopTone();
                    speakCentralita("Abriendo marcador del sistema...", () => {
                        if (cState === 'idle') return;
                        // Limpiar número para protocolo tel: (quitar espacios)
                        const cleanPhone = contact.phone.replace(/\s/g, '');
                        // Usar window.open para evitar problemas de redirect en algunos navegadores
                        window.open(`tel:${cleanPhone}`, '_self');
                        cSetStatus('outbound', 'LLAMADA EXTERNA EN CURSO...');
                        cAddToLog(contact.name, "Llamada externa iniciada");
                        // No colgar automático: dejar que el usuario cuelgue manualmente para cerrar ficha
                    });
                }, 2000);
            } else {
                // LLAMADA INTERNA (REACHABLE VIA PEER ID)
                cPlayTone(440, 480, 0.03);
                if (peer) {
                    const call = peer.call(contact.phone, audioCtx ? audioCtx.destination.stream : null);
                    if (call) {
                        call.on('stream', (stream) => {
                            remoteStream = stream;
                            cMechanicAccept();
                        });
                        currentPeerCall = call;
                    } else {
                        setTimeout(() => {
                            cStopTone();
                            speakCentralita("El dispositivo de destino no responde.", () => cHangup());
                        }, 5000);
                    }
                }
            }
        }

        function cMakeVoiceCall(name) {
            const c = C_CALLERS.find(x => x.name.toLowerCase().includes(name.toLowerCase()));
            if (c) cMakeCallTo(c);
            else speakCentralita(`Lo siento, no he encontrado a ${name} en la agenda.`, null);
        }

        function initNetworkDetection() {
            const update = () => {
                const on = navigator.onLine;
                const netLabel = $('c-net-label');
                if (!netLabel) return;

                // Detectar tipo de conexión (si el navegador lo permite)
                const conn = navigator.connection || navigator.mozConnection || navigator.webkitConnection;
                let typeText = "REDI LOCAL";

                if (conn) {
                    if (conn.type === 'wifi') typeText = "WIFI: AUTOMA_TALLER_PRO";
                    else if (conn.type === 'cellular') typeText = "DATOS: RED_MOVIL";
                    else if (conn.effectiveType) {
                        typeText = `DATOS: ${conn.effectiveType.toUpperCase()}`;
                    }
                } else {
                    // Fallback para PC o navegadores sin API connection
                    typeText = on ? "WIFI / RED LOCAL" : "SIN CONEXIÓN";
                }

                netLabel.innerText = on ? typeText : 'SIN CONEXIÓN RED';
                netLabel.style.color = on ? 'var(--primary)' : 'var(--danger)';

                // Actualizar barras de señal
                const bars = document.querySelectorAll('.s-bar');
                bars.forEach((b, i) => {
                    if (on) {
                        if (i < 3) b.classList.add('active');
                        else b.classList.remove('active');
                    } else {
                        b.classList.remove('active');
                    }
                });
            };
            window.addEventListener('online', update);
            window.addEventListener('offline', update);
            update();
        }

        function initPeerSync() {
            const email = getSavedEmail() || 'taller_anonimo';
            const cleanEmail = email.replace(/[^a-zA-Z0-9]/g, '_');
            // Generar un ID único para este dispositivo
            const devId = (isMobileLike() ? 'mob_' : 'pc_') + cleanEmail;

            try {
                peer = new Peer(devId);
                peer.on('open', (id) => {
                    myPeerId = id;
                    console.log('Centralita conectada. ID:', id);
                });
                peer.on('call', (call) => {
                    cCurrentCaller = { name: "LLAMADA ENTRANTE", phone: call.peer };
                    cSetStatus('ringing', 'CONEXIÓN VOIP P2P...');
                    $('c-caller-id').innerText = call.peer;
                    $('c-btn-hangup').disabled = false;

                    // Contestar automáticamente con el stream del micro (IA Switchboard)
                    navigator.mediaDevices.getUserMedia({ audio: true }).then(stream => {
                        call.answer(stream);
                        call.on('stream', (remStream) => {
                            remoteStream = remStream;
                            cMechanicAccept();
                        });
                    });
                    currentPeerCall = call;
                });
            } catch (e) { console.error("PeerJS error:", e); }
        }

        function initTheme() {
            const saved = localStorage.getItem('adp_theme');
            if (saved === 'light') {
                document.body.classList.add('light-theme');
                const icon = $('theme-icon');
                if (icon) icon.className = 'fas fa-moon';
            }
        }

        function toggleTheme() {
            const isLight = document.body.classList.toggle('light-theme');
            const icon = $('theme-icon');
            if (icon) icon.className = isLight ? 'fas fa-moon' : 'fas fa-sun';
            localStorage.setItem('adp_theme', isLight ? 'light' : 'dark');
        }

        function configurarTaller() {
            // Verificar plan actual (simulado o desde storage)
            const plan = localStorage.getItem("adp_plan") || "STARTER (Demo)";
            const email = getSavedEmail() || "No registrado";

            alert(`👤 CUENTA DE TALLER\n\n- ID: ${email}\n- PLAN ACTUAL: ${plan.toUpperCase()}\n- ESTADO: ACTIVO ✅\n- PRÓXIMA FACTURA: 01/02/2026\n\n(Para gestionar pagos, contacta con soporte)`);
        }

        document.addEventListener("DOMContentLoaded", () => {
            initNetworkDetection();
            initPeerSync();
            initTheme();
            seedDemoData(); // ACTIVAR PLANTILLA DEMO
        });

        // =========================================
        // SUSCRIPCIÓN
        // =========================================
        function goStripe() { window.location.href = "/subscribe?provider=stripe"; }
        function goPayPal() { window.location.href = "/subscribe?provider=paypal"; }

        // =========================================
        // PARTNERS ROTATOR (MONETIZABLE BANNER)
        // =========================================
        const PARTNERS = [
            {
                name: "BOSCH Car Service",
                tag: "Diagnosis",
                desc: "Equipamiento líder mundial. Soluciones de taller.",
                url: "https://www.boschcarservice.com/",
                img: "https://logo.clearbit.com/bosch.com"
            },
            {
                name: "CASTROL PRO",
                tag: "Lubricantes",
                desc: "Ingeniería líquida para motores de alto rendimiento.",
                url: "https://www.castrol.com/",
                img: "https://logo.clearbit.com/castrol.com"
            },
            {
                name: "BREMBO",
                tag: "Frenos",
                desc: "Líder mundial en sistemas de frenos.",
                url: "https://www.brembo.com/",
                img: "https://logo.clearbit.com/brembo.com"
            },
            {
                name: "MICHELIN",
                tag: "Neumáticos",
                desc: "Movilidad sostenible y seguridad premium.",
                url: "https://www.michelin.es/",
                img: "https://logo.clearbit.com/michelin.com"
            },
            {
                name: "VALEO",
                tag: "Recambios",
                desc: "Tecnología inteligente para movilidad.",
                url: "https://www.valeo.com/",
                img: "https://logo.clearbit.com/valeo.com"
            }
        ];

        let currentPartnerIdx = 0;
        let partnerTimer;

        function initPartnerRotator() {
            renderPartner(0);
            // Rotación automática cada 4 segundos
            partnerTimer = setInterval(() => {
                currentPartnerIdx = (currentPartnerIdx + 1) % PARTNERS.length;
                renderPartner(currentPartnerIdx);
            }, 4000);
        }

        function renderPartner(idx) {
            const p = PARTNERS[idx];

            // Actualizar elementos existentes por ID
            const nameEl = $('partner-name');
            const tagEl = $('partner-tag');
            const descEl = $('partner-desc');
            const btn = $('partner-cta');

            // Si existen los elementos (estructura HTML v5)
            if (nameEl && tagEl && descEl) {
                // Inyectar imagen de marca junto al nombre
                nameEl.innerHTML = `
                    <div style="display:flex; align-items:center; gap:10px;">
                        <img src="${p.img}" style="width:24px; height:24px; object-fit:contain; border-radius:4px; background:white;"> 
                        <span>${p.name}</span>
                    </div>
                `;
                tagEl.innerText = p.tag;

                // Descripción más visual
                descEl.innerHTML = `
                    <div style="display:flex; flex-direction:column; gap:5px;">
                        <img src="${p.img}" style="width:100%; height:80px; object-fit:cover; border-radius:6px; opacity:0.8; margin-bottom:5px;">
                        <span>${p.desc}</span>
                    </div>
                `;

                if (btn) {
                    btn.onclick = () => window.open(p.url, '_blank');
                    btn.innerText = "VER OFERTA " + p.name;
                }
            }
        }

        // Exponer para onclick manual si hiciera falta
        window.partnerClick = () => {
            const p = PARTNERS[currentPartnerIdx];
            window.open(p.url, '_blank');
        };

        document.addEventListener("DOMContentLoaded", () => {
            initPartnerRotator();
        });

        // =========================================
        // HEADER / NAV
        // =========================================
        function toggleActividad() {
            // Simula abrir panel lateral
            alert("Panel de Actividad Reciente (Logs) aún no conectado a backend.");
        }
        function nuevaFicha() {
            const m = $('miModal');
            if (m) m.style.display = 'block';
        }
        function cerrarModal() {
            const m = $('miModal');
            if (m) m.style.display = 'none';
        }
        function guardarFicha() {
            const mat = $('matricula').value;
            const prop = $('propietario').value;
            if (!mat || !prop) return alert("Rellena matrícula y propietario");

            alert(`Ficha guardada para ${mat} (${prop}).\nSe ha enviado notificación WhatsApp (simulado).`);
            cerrarModal();
        }
        function buscarDesdeWidget() {
            const q = $('search_q').value;
            if (!q) return alert("Introduce matrícula o OT");
            alert("Buscando expediente: " + q + "...");
        }

        // =========================================
        // DIAGNOSTICO IA
        // =========================================
        function diagStart() {
            const txt = $('diag-input').value;
            if (!txt) return alert("Describe el problema primero.");

            const box = $('diag-result');
            box.innerHTML = `<div style="color:var(--accent);">Analizando con IA Auto-Expert...</div>`;

            setTimeout(() => {
                diagState = {
                    averia: "Bomba de agua obstruida / Fuga refrigerante",
                    solucion: "Reemplazar bomba de agua + kit distribución",
                    tiempo: "2.5h",
                    piezas: ["Bomba Agua (SKF)", "Correa Distribución", "Anticongelante G12"]
                };
                diagClientText = `Diagnóstico preliminar: ${diagState.averia}. Solución recomendada: ${diagState.solucion}. Estimación: ${diagState.tiempo}.`;

                box.innerHTML = `
                    <div class="sec">CAUSA PROBABLE (IA 98%)</div>
                    <div>${diagState.averia}</div>
                    <div class="sec">SOLUCIÓN SUGERIDA</div>
                    <div>${diagState.solucion}</div>
                    <div class="sec">TIEMPO / PIEZAS</div>
                    <div>${diagState.tiempo} | ${diagState.piezas.join(", ")}</div>
                `;
            }, 1500);
        }

        function diagReset() {
            $('diag-input').value = "";
            $('diag-result').innerHTML = `<div class="muted">El diagnóstico aparecerá aquí...</div>`;
            diagState = null;
        }

        function diagCopyClient() {
            if (!diagState) return alert("Primero realiza un diagnóstico.");
            navigator.clipboard.writeText(diagClientText).then(() => alert("Texto para cliente copiado!"));
        }

        // =========================================
        // RECEPCIÓN ACTIVA (RX)
        // =========================================
        function rxToggle() {
            const list = $('rx-checklist');
            list.style.display = (list.style.display === 'none') ? 'block' : 'none';
        }
        function rxUseDiagText() {
            if (!diagState) return alert("No hay diagnóstico activo.");
            $('rx-obs').value = "Diagnóstico Previo: " + diagState.averia + "\n" + $('rx-obs').value;
        }
        function rxSaveDraft() {
            alert("Borrador de recepción guardado localmente.");
        }
        function rxLoadDraft() {
            alert("No hay borradores guardados recientes.");
        }
        function rxCreateOT() {
            const km = $('rx_km')?.value; // ID corregido
            const comb = $('rx_comb')?.value; // ID corregido
            if (!km) return alert("Indica Kilometraje");
            alert(`OT Creada con éxito para recepción.\nKilómetros: ${km}\nCombustible: ${comb}\nSe ha generado PDF de resguardo (simulado).`);
        }

        // =========================================
        // ORDEN DE TRABAJO (OT)
        // =========================================
        // ORDEN DE TRABAJO (OT)
        // =========================================
        function otCalc() {
            // Fix: IDs correctos ot_horas y ot_precio_hora
            const horas = parseFloat($('ot_horas').value) || 0;
            const precio = parseFloat($('ot_precio_hora').value) || 0;

            // Asumimos recambios parseados o 0 si no hay input numérico específico (usamos texto)
            // Para simplificar, calculamos solo MO en esta corrección
            const mo = horas * precio;
            const rec = 0; // Se podría extraer del texto o añadir input si se pide

            const subtotal = mo + rec;
            const iva = subtotal * 0.21;
            const total = subtotal + iva;

            if ($('tot_mo')) $('tot_mo').innerText = mo.toFixed(2) + "€";
            if ($('tot_rec')) $('tot_rec').innerText = rec.toFixed(2) + "€";
            if ($('tot_sub')) $('tot_sub').innerText = subtotal.toFixed(2) + "€";
            if ($('tot_iva')) $('tot_iva').innerText = iva.toFixed(2) + "€";
            if ($('tot_total')) $('tot_total').innerText = total.toFixed(2) + "€";
        }

        function otSaveLocal() {
            localStorage.setItem('temp_ot_mo', $('ot-mo').value);
            localStorage.setItem('temp_ot_pz', $('ot-pz').value);
            alert("OT guardada en navegador.");
        }
        function otSendBudget() {
            const t = $('ot-total-show').innerText;
            if (t === "0.00 €") return alert("Calcula primero el presupuesto.");
            alert(`Presupuesto de ${t} enviado al cliente por WhatsApp/Email.`);
        }

        // =========================================
        // FACTURACIÓN + VERI*FACTU
        // =========================================
        function vfFromOT() {
            // Fix: usar mismos IDs que otCalc
            const horas = parseFloat($('ot_horas').value) || 0;
            const precio = parseFloat($('ot_precio_hora').value) || 0;
            const mo = horas * precio;

            if (mo === 0) return alert("Calcula la OT primero (o es 0).");

            $('vf_base').value = mo.toFixed(2);
            vfCalc();
        }
        function vfCalc() {
            const base = parseFloat($('vf_base').value) || 0;
            const iva = base * 0.21;
            const total = base + iva;
            $('vf_total').value = total.toFixed(2);
            $('vf_status').innerHTML = "Cálculo listo para emitir.";
        }
        function vfEmit() {
            const tot = $('vf_total').value;
            if (!tot) return alert("Calcula totales primero.");

            let statusMsg = `<span style="color:var(--primary);"><i class="fas fa-check"></i> EMITIDA: T-2025-${Math.floor(Math.random() * 1000)}</span>`;

            // Simulación Veri*Factu
            if ($('vf_auto').checked) {
                statusMsg += " | <i class='fas fa-fingerprint'></i> <b>Conectando AEAT... [OK]</b> Huella digital generada.";
            }

            $('vf_status').innerHTML = statusMsg;
        }

        // =========================================
        // YOUTUBE MECÁNICA
        // =========================================
        function ytOpen() {
            const q = $('yt_query')?.value; // ID corregido
            if (!q) return alert("Escribe qué buscar (ej: EGR 1.6 TDI)");
            window.open(`https://www.youtube.com/results?search_query=Mecánica+${encodeURIComponent(q)}`, '_blank');
        }
        function ytSearch() {
            const q = $('yt_query')?.value; // ID corregido
            if (!q) return;
            const iframe = $('yt_iframe');
            if (iframe) {
                iframe.src = `https://www.youtube.com/embed?listType=search&list=${encodeURIComponent(q + ' mecánica')}`;
                $('yt_title').innerText = "Búsqueda: " + q;
            }
        }
        function ytSetDefault() {
            const iframe = $('yt_iframe');
            if (iframe) {
                iframe.src = "https://www.youtube.com/embed/videoseries?list=PLrEnWoR732-D67iteOI6DPdJH1opjAuJt";
                $('yt_title').innerText = "Playlist Mecánica";
                if ($('yt_query')) $('yt_query').value = "";
            }
        }

        // =========================================
        // GRABADORA DE RUIDOS
        // =========================================
        let recMediaRecorder;
        let recChunks = [];

        async function recStart() {
            try {
                // Sincronizar con IDs nuevos
                const startBtn = $('recStart');
                const stopBtn = $('recStop');
                const saveBtn = $('recSave');
                const status = $('recStatus');

                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                recMediaRecorder = new MediaRecorder(stream);
                recChunks = [];
                recMediaRecorder.ondataavailable = e => recChunks.push(e.data);
                recMediaRecorder.onstop = () => {
                    const blob = new Blob(recChunks, { 'type': 'audio/ogg; codecs=opus' });
                    const url = window.URL.createObjectURL(blob);
                    addAudioToList(url);
                    if (saveBtn) saveBtn.disabled = false;
                };
                recMediaRecorder.start();
                if (startBtn) startBtn.disabled = true;
                if (stopBtn) stopBtn.disabled = false;
                if (status) status.innerText = "GRABANDO EVIDENCIA...";
            } catch (e) {
                alert("Micro-permiso denegado o no disponible.");
            }
        }
        function recStop() {
            if (recMediaRecorder && recMediaRecorder.state !== 'inactive') {
                recMediaRecorder.stop();
                if ($('recStart')) $('recStart').disabled = false;
                if ($('recStop')) $('recStop').disabled = true;
                if ($('recStatus')) $('recStatus').innerText = "Grabación finalizada.";
            }
        }
        function recSave() {
            alert("Evidencia guardada con éxito en el servidor.");
            if ($('recSave')) $('recSave').disabled = true;
        }
        function addAudioToList(url) {
            const list = $('audioList'); // ID corregido
            if (!list) return;
            const div = document.createElement('div');
            div.className = "item";
            div.innerHTML = `
                <div class="audio-meta">
                    <span>${new Date().toLocaleTimeString()}</span>
                    <span class="badge" style="color:var(--danger);">EVIDENCIA</span>
                </div>
                <div style="display:flex; align-items:center; gap:5px; margin-top:5px;">
                    <audio controls src="${url}" style="width:100%; height:30px;"></audio>
                    <button class="mini-btn" style="background:var(--danger); border:none; padding:5px 10px;" onclick="this.closest('.item').remove()">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            `;
            const empty = list.querySelector('.muted');
            if (empty) empty.remove();
            list.prepend(div);
        }

        // =========================================
        // OBD
        // =========================================
        function obdExplain() {
            const code = $('obd-code').value.toUpperCase();
            if (!code) return alert("Introduce código (ej: P0300)");

            const definitions = {
                "P0300": "Fallo de encendido aleatorio/múltiple.",
                "P0420": "Eficiencia catalizador por debajo umbral (Banco 1).",
                "P0171": "Sistema demasiado pobre (Banco 1).",
                "P0401": "Flujo insuficiente EGR."
            };
            const def = definitions[code] || "Código estándar de motor. Requiere diagnóstico específico.";
            $('obd-result').innerHTML = `<b>${code}</b>: ${def}`;
        }

        // =========================================
        // MENSAJERÍA
        // =========================================
        let currentRole = 'taller'; // 'taller' | 'cliente' | 'ia'
        function setMsgRole(r) {
            currentRole = r;
            document.querySelectorAll('.role-pill').forEach(el => el.classList.remove('active'));
            if (r === 'taller') $('role-taller').classList.add('active');
            if (r === 'cliente') $('role-cliente').classList.add('active');
            if (r === 'ia') $('role-ia').classList.add('active');
        }
        function msgSend() {
            const txt = $('msg-input').value;
            if (!txt) return;

            const list = $('msg-list');
            let color = "#e6edf3";
            let sender = "Taller";
            if (currentRole === 'cliente') { color = "#94a3b8"; sender = "Cliente"; }
            if (currentRole === 'ia') { color = "var(--accent)"; sender = "IA Auto"; }

            list.innerHTML += `
                <div class="msg-item">
                    <div class="msg-meta">
                        <span>${sender}</span>
                        <span>${new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}</span>
                    </div>
                    <div class="msg-text" style="color:${color}">${txt}</div>
                </div>
            `;
            $('msg-input').value = "";
            list.scrollTop = list.scrollHeight;
        }
        function msgForceRefresh() {
            alert("Sincronizando chats (WhatsApp/Telegram)... OK");
        }

        // =========================================
        // SMART HISTORY
        // =========================================
        function smartRefresh() {
            $('smart-box').innerHTML = `
                <div style="margin-bottom:6px;"><i class="fas fa-exclamation-triangle" style="color:#e3b341;"></i> ITV próxima (15 días)</div>
                <div style="margin-bottom:6px;"><i class="fas fa-oil-can" style="color:#e3b341;"></i> Cambio aceite recomendado</div>
            `;
        }
        function smartCopy() {
            alert("Recordatorios copiados para enviar al cliente.");
        }

        // =========================================
        // EVIDENCIAS
        // =========================================
        function eviCopy() {
            alert("Evidencia copiada con Hash SHA-256 (Simulado) al portapapeles.");
        }
        function eviClear() {
            $('evi-box').innerHTML = `<div style="color:#94a3b8;">Evidencias limpiadas. Sesión nueva iniciada.</div>`;
        }

        // =========================================
        // EXTERNAL
        // =========================================
        function abrirTelegram() { window.open('https://web.telegram.org', '_blank'); }
        function pedidoRapido() {
            // Arreglado: ahora hace algo
            window.open('https://www.castrol.com/es_es/spain/home/automotive/lubricant-finder.html', '_blank');
        }

        // =========================================
        // LÓGICA TOUR INTERACTIVO (REFINADA)
        // =========================================
        let currentDemoSlide = 1;
        let demoTimeout;
        let synth = window.speechSynthesis;
        let voiceEnabled = false;
        let typingInterval;
        let isPaused = false;

        function togglePlayPause() {
            isPaused = !isPaused;
            const icon = $('play-pause-icon');
            const pill = $('demo-status-pill');

            if (isPaused) {
                icon.className = "fas fa-play";
                if (pill) pill.innerText = "PAUSADO";
                clearTimeout(demoTimeout);
                synth.pause();
                // Detener barra
                const bar = $('demo-bar');
                if (bar) bar.style.animationPlayState = 'paused';
            } else {
                icon.className = "fas fa-pause";
                if (pill) pill.innerText = "TOUR INTERACTIVO";
                synth.resume();

                // Si la voz está desactivada o ya terminó, forzamos el siguiente paso
                if (!synth.speaking) {
                    demoTimeout = setTimeout(nextDemoSlide, 2000);
                }

                const bar = $('demo-bar');
                if (bar) bar.style.animationPlayState = 'running';
            }
        }

        function toggleVoice() {
            voiceEnabled = !voiceEnabled;
            const icon = $('voice-icon');
            const txt = $('voice-text');
            if (voiceEnabled) {
                icon.className = "fas fa-volume-up";
                txt.innerText = "Voz Activada";
                if (!isPaused) startSlideAction(currentDemoSlide);
            } else {
                icon.className = "fas fa-volume-mute";
                txt.innerText = "Voz Desactivada";
                synth.cancel();
            }
        }

        function typeWriter(text, element) {
            if (!element) return;
            element.innerHTML = "";
            let i = 0;
            clearInterval(typingInterval);
            typingInterval = setInterval(() => {
                if (i < text.length) {
                    element.innerHTML += text.charAt(i);
                    i++;
                } else {
                    clearInterval(typingInterval);
                }
            }, 30); // Velocidad de escritura
        }

        function nextDemoSlide() {
            if (isPaused) return;
            const totalSlides = 6;
            clearTimeout(demoTimeout);

            // Quitar resaltado anterior
            document.querySelectorAll('.highlight-focus').forEach(el => el.classList.remove('highlight-focus'));

            const oldSlide = $(`slide-${currentDemoSlide}`);
            if (oldSlide) oldSlide.classList.remove('active');

            currentDemoSlide = (currentDemoSlide % totalSlides) + 1;

            startSlideAction(currentDemoSlide);
        }

        function startSlideAction(slideNum) {
            const slide = $(`slide-${slideNum}`);
            if (!slide) return;

            slide.classList.add('active');

            // 1. Resaltado y Scroll
            const targetId = slide.getAttribute('data-target');
            const targetEl = $(targetId);
            if (targetEl) {
                targetEl.classList.add('highlight-focus');
                targetEl.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }

            // 2. Efecto de escritura
            const textEl = slide.querySelector('.demo-text');
            if (textEl) {
                if (!textEl.getAttribute('data-full-text')) {
                    textEl.setAttribute('data-full-text', textEl.innerText);
                }
                const fullText = textEl.getAttribute('data-full-text');
                typeWriter(fullText, textEl);
            }

            // 3. Voz y transición
            if (voiceEnabled) {
                const voiceText = slide.getAttribute('data-voice');
                speakText(voiceText);
            } else {
                // Si no hay voz, transición automática tras 7 segundos (más pausado)
                demoTimeout = setTimeout(nextDemoSlide, 7000);
            }

            // Barra de progreso sincronizada con el tiempo de espera por defecto
            const bar = $('demo-bar');
            if (bar) {
                bar.style.transition = 'none';
                bar.style.width = '0%';
                setTimeout(() => {
                    bar.style.transition = 'width 7s linear';
                    bar.style.width = '100%';
                }, 10);
            }
        }

        function speakText(text) {
            if (!text || !voiceEnabled || isPaused) return;
            synth.cancel();

            const utter = new SpeechSynthesisUtterance(text);
            utter.lang = 'es-ES';
            utter.rate = 0.85; // Velocidad más humana y pausada
            utter.pitch = 1.0;

            utter.onstart = () => {
                const tech = $('tech-voice');
                if (tech) tech.classList.add('active');
            };

            utter.onend = () => {
                const tech = $('tech-voice');
                if (tech) tech.classList.remove('active');
                // Esperar 2 segundos de pausa natural antes de pasar
                if (!isPaused) {
                    demoTimeout = setTimeout(nextDemoSlide, 2000);
                }
            };

            synth.speak(utter);
        }

        function restartDemo() {
            clearTimeout(demoTimeout);
            currentDemoSlide = 6;
            nextDemoSlide();
            if ($('demo-status-pill')) $('demo-status-pill').innerText = "TOUR INTERACTIVO";
        }

        document.addEventListener("DOMContentLoaded", () => {
            // Inicializar textos para el efecto typewriter
            document.querySelectorAll('.demo-text').forEach(el => {
                el.setAttribute('data-full-text', el.innerText);
                el.innerHTML = "";
            });

            setTimeout(restartDemo, 1000);
        });

        // =========================================
        // VIDEO FOSO (AUTO-DETECT + IP)
        // =========================================
        let currentStream = null;

        function abrirVideoFoso() {
            const m = $('videoModal');
            if (m) {
                m.style.display = 'flex';
                detectCameras();
            }
        }

        function closeVideoModal() {
            const m = $('videoModal');
            if (m) m.style.display = 'none';
            stopStream();
        }

        function stopStream() {
            if (currentStream) {
                currentStream.getTracks().forEach(t => t.stop());
                currentStream = null;
            }
            const v = $('liveFeed');
            if (v) { v.src = ""; v.srcObject = null; }
        }

        async function detectCameras() {
            const sel = $('camSelector');
            sel.innerHTML = "<option value=''>Buscando dispositivos...</option>";

            try {
                // 1. Pedir permisos y liberar INMEDIATAMENTE para no ocupar la cámara
                const stream = await navigator.mediaDevices.getUserMedia({ video: true });
                stream.getTracks().forEach(track => track.stop());

                // 2. Ahora que tenemos permiso, listamos
                const devices = await navigator.mediaDevices.enumerateDevices();
                const videos = devices.filter(d => d.kind === 'videoinput');

                sel.innerHTML = "";

                // 3. Rellenamos select
                videos.forEach((cam, idx) => {
                    const opt = document.createElement('option');
                    opt.value = "local:" + cam.deviceId;
                    opt.text = cam.label || `Cámara ${idx + 1} (USB/Integrada)`;
                    sel.appendChild(opt);
                });

                // 4. IP Guardada
                const savedIP = localStorage.getItem("adp_cam_url");
                if (savedIP) {
                    const opt = document.createElement('option');
                    opt.value = "ip:" + savedIP;
                    opt.text = "🌐 Cámara WiFi/IP Guardada";
                    if (!videos.length) opt.selected = true;
                    sel.appendChild(opt);
                }

                if (!sel.value && videos.length > 0) sel.value = "local:" + videos[0].deviceId;

                switchCamera(sel.value);

            } catch (e) {
                sel.innerHTML = "<option>Error de permisos/cámara</option>";
                // alert("Error al detectar cámaras: " + e.message); // Omitimos alert intrusivo
                console.error(e);
            }
        }

        function toggleFullscreen() {
            const elem = $('liveFeed');
            if (!document.fullscreenElement) {
                elem.requestFullscreen().catch(err => {
                    alert(`Error al intentar pantalla completa: ${err.message}`);
                });
            } else {
                document.exitFullscreen();
            }
        }

        function switchCamera(val) {
            stopStream();
            const video = $('liveFeed');

            if (!val) return;

            if (val.startsWith("ip:")) {
                const url = val.split("ip:")[1];
                alert("Abriendo cámara IP en ventana externa...");
                window.open(url, '_blank', 'width=800,height=600');
            } else if (val.startsWith("local:")) {
                const devId = val.split("local:")[1];

                // Pequeño delay para asegurar que el anterior se cerró
                setTimeout(() => {
                    navigator.mediaDevices.getUserMedia({ video: { deviceId: { exact: devId } } })
                        .then(stream => {
                            currentStream = stream;
                            video.srcObject = stream;
                            // Asegurar reproducción
                            video.play().catch(e => console.log("Auto-play prevented", e));
                        })
                        .catch(e => {
                            console.error(e);
                            alert("Error al abrir cámara: " + e.message + "\nIntenta reconectar el dispositivo.");
                        });
                }, 100);
            }
        }

        function addIpCam() {
            const url = prompt("Introduce URL de Cámara WiFi (ej: http://192.168.1.XX:8080):", "http://");
            if (url) {
                localStorage.setItem("adp_cam_url", url);
                detectCameras();
            }
        }

        // =========================================
        // AUTOMA PRO 2050 UTILS
        // =========================================

        // --- CONFIGURACIÓN DE TALLER (Logo y Nombre) ---
        function configurarTaller() {
            const nombre = prompt("Nombre del Taller:");
            const logoUrl = prompt("URL del Logo (Imágenes cuadradas, o local relativo):");
            if (nombre) document.getElementById('taller-nombre').innerText = nombre;
            if (logoUrl) document.getElementById('taller-logo').src = logoUrl;
        }

        // --- IA EXPERTA EN OBD (Comportamiento Mecánico) ---
        function consultarIAOBD() {
            const code = document.getElementById('obd-code').value.toUpperCase();
            const model = document.getElementById('obd-model').value;
            const output = document.getElementById('ia-output');

            if (!code) return alert("Introduce un DTC (ej: P0420)");

            output.innerHTML = "<i class='fas fa-spinner fa-spin'></i> Analizando bases de datos de fabricante y boletines técnicos...";

            setTimeout(() => {
                output.innerHTML = `
                    <b style="color:var(--primary)">ANÁLISIS IA PARA ${code}:</b><br>
                    1. <b>Causa Probable:</b> Fuga de vacío en manguito de admisión o fallo en sensor de oxígeno.<br>
                    2. <b>Protocolo Taller:</b> Verificar estanqueidad con máquina de humo. Comprobar voltajes en vivo del sensor O2.<br>
                    3. <b>Recambios:</b> Sensor O2 Bosch Ref: 0258017025.<br>
                    <small style="color:var(--gold)">*Nota: En ${model || 'este modelo'}, este fallo suele ser causado por combustible de baja calidad.</small>
                `;
            }, 1500);
        }

        function copiarProtocolo() {
            const out = document.getElementById('ia-output').innerText;
            navigator.clipboard.writeText(out).then(() => alert("Protocolo copiado al portapapeles."));
        }

        // --- SEGURIDAD S.O.S (Detección Hombre Caído) ---
        function iniciarAlertaSOS() {
            const widget = document.getElementById('sos-widget');
            const status = document.getElementById('sos-status');
            if (!widget) return;

            widget.style.background = "var(--danger)";
            status.innerHTML = "<b style='color:#fff'>¡IMPACTO DETECTADO! LLAMANDO AL 112 EN 10s...</b>";

            let count = 10;
            if (window.sosInterval) clearInterval(window.sosInterval);

            window.sosInterval = setInterval(() => {
                count--;
                status.innerHTML = `<b style='color:#fff'>Llamando al 112 en ${count}s... TOCA PARA CANCELAR</b>`;
                if (count <= 0) {
                    clearInterval(window.sosInterval);
                    status.innerHTML = "<b style='color:#fff'>LLAMANDO A AMBULANCIA: TRANSMITIENDO DATOS...</b>";
                    alert("SIMULACIÓN: Llamando a Servicios de Emergencia (112) con coordenadas GPS.");
                    widget.style.background = "";
                    status.innerHTML = "ESTADO: ALERTA ENVIADA";
                }
            }, 1000);

            widget.onclick = () => {
                clearInterval(window.sosInterval);
                widget.style.background = "";
                status.innerText = "ALERTA CANCELADA POR EL USUARIO";
                setTimeout(() => {
                    status.innerText = "ESTADO: ESCANEANDO MOVIMIENTO";
                    widget.onclick = null; // Quitar listener para no bloquear
                }, 3000);
            };
        }

        function triggerManualSOS() {
            iniciarAlertaSOS();
        }

        // --- PRL DINÁMICO ---
        const tips = [
            "Usa siempre protección ocular al trabajar bajo el vehículo.",
            "Recuerda: El elevador debe tener los bloqueos de seguridad activos.",
            "Mantén el suelo libre de derrames de aceite para evitar caídas.",
            "Lávate las manos antes de comer: el plomo y químicos son tóxicos."
        ];
        let tipIdx = 0;
        setInterval(() => {
            const el = document.getElementById('prl-info');
            if (el) {
                el.innerText = tips[tipIdx];
                tipIdx = (tipIdx + 1) % tips.length;
            }
        }, 10000);

        // =========================================
        // INIT
        // =========================================
        startClock();

        // =========================================
        // CHART INIT
        // =========================================
        document.addEventListener("DOMContentLoaded", () => {
            const ctx = document.getElementById('talleresChart').getContext('2d');
            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: ['Ene', 'Feb', 'Mar', 'Abr', 'May', 'Jun', 'Jul', 'Ago', 'Sep', 'Oct', 'Nov', 'Dic'],
                    datasets: [{
                        label: 'Talleres Suscritos',
                        data: [120, 150, 180, 240, 300, 380, 450, 510, 600, 720, 810, 850], // Datos ficticios
                        borderColor: '#4ade80',
                        backgroundColor: 'rgba(74, 222, 128, 0.1)',
                        borderWidth: 2,
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { labels: { color: '#e6edf3' } }
                    },
                    scales: {
                        y: {
                            ticks: { color: '#94a3b8' },
                            grid: { color: '#30363d' }
                        },
                        x: {
                            ticks: { color: '#94a3b8' },
                            grid: { color: '#30363d' }
                        }
                    }
                }
            });
        });

        // =========================================
        // SUSCRIPCIÓN & LEADS
        // =========================================
        const CHECKOUT_LINKS = {
            starter: "/subscribe?provider=stripe&plan=starter",
            pro: "/subscribe?provider=stripe&plan=pro",
            elite: "/subscribe?provider=stripe&plan=elite"
        };
        let currentPlan = "";

        function openSignup(plan) {
            currentPlan = plan || "pro";
            document.getElementById('signupPlanBadge').innerText = currentPlan.toUpperCase();
            document.getElementById('signupModal').style.display = 'block';
            // Pre-fill email if known
            const saved = getSavedEmail();
            if (saved) document.getElementById('lead_email').value = saved;
        }

        function closeSignup() {
            document.getElementById('signupModal').style.display = 'none';
        }

        function startCheckout(plan) {
            openSignup(plan);
        }

        async function submitLead(goPay) {
            const taller = document.getElementById('lead_taller').value;
            const contacto = document.getElementById('lead_contacto').value;
            const tel = document.getElementById('lead_tel').value;
            const email = document.getElementById('lead_email').value;
            const notas = document.getElementById('lead_notas').value;

            if (!taller || !contacto || !email) return alert("Por favor rellena: Taller, Contacto y Email.");

            // Guardar local para email del usuario
            setSavedEmail(email);

            // ✅ SINCRONIZAR CON AGENDA CENTRALITA
            if (tel) {
                saveStoredContact(contacto, tel);
            }

            const payload = {
                plan: currentPlan,
                nombre_taller: taller,
                contacto: contacto,
                telefono: tel,
                email: email,
                notas: notas
            };

            // Enviar backend
            try {
                await fetch("/api/leads", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(payload)
                });
            } catch (e) {
                console.log("Error enviando lead (fallback local)", e);
            }

            if (goPay) {
                const link = CHECKOUT_LINKS[currentPlan];
                window.location.href = link + "&email=" + encodeURIComponent(email);
            } else {
                alert("¡Solicitud de Demo recibida! Te contactaremos pronto.");
                closeSignup();
            }
        }

        // =========================================
        // WHATSAPP INTEGRATION
        // =========================================
        function abrirWhatsApp() {
            // Abrir versión web o app
            window.open('https://web.whatsapp.com/', '_blank');
        }

        function otSendWhatsapp() {
            const tel = document.getElementById('rx_tel')?.value || document.getElementById('telefono')?.value || "";
            const total = document.getElementById('tot_total')?.innerText || "0.00€";
            const modelo = document.getElementById('rx_matricula')?.value || "su vehículo";

            if (!tel) return alert("Por favor, introduce un teléfono en la Recepción o Ficha.");

            // Eliminar caracteres no numéricos excepto el + inicial si existe, pero para wa.me mejor solo números
            const cleanTel = tel.replace(/\D/g, '');
            if (cleanTel.length < 9) return alert("El número de teléfono parece incompleto.");

            const msg = `Hola! Somos AutomaDrive. El presupuesto para ${modelo} es de ${total}. ¿Desea aprobarlo?`;
            const url = `https://wa.me/${cleanTel}?text=${encodeURIComponent(msg)}`;
            window.open(url, '_blank');
        }

        // =========================================
        // IA AGENTE DE AUTOCURACIÓN (SELF-HEALING)
        // =========================================
        window.onerror = function (msg, url, line, col, error) {
            // Evitamos bucles
            if (msg.includes("Script error")) return;
            console.warn("IA AutomaDrive: Interceptado error en " + line + ":" + col);
            activarProtocoloAutocuracion(msg);
            return true; // Prevenir error en consola roja
        };

        window.onunhandledrejection = function (event) {
            console.warn("IA AutomaDrive: Promesa fallida interceptada.");
            activarProtocoloAutocuracion(event.reason);
        };

        function activarProtocoloAutocuracion(detalles) {
            // 1. Notificar visualmente
            let status = document.getElementById('ai-status-overlay');
            if (!status) {
                status = document.createElement('div');
                status.id = 'ai-status-overlay';
                status.style.position = 'fixed';
                status.style.bottom = '20px';
                status.style.right = '20px';
                status.style.background = '#0d1117';
                status.style.border = '1px solid var(--accent)';
                status.style.padding = '15px';
                status.style.borderRadius = '8px';
                status.style.zIndex = '9999';
                status.style.boxShadow = '0 0 20px rgba(0,242,255,0.2)';
                status.style.animation = 'fadeIn 0.5s ease';
                document.body.appendChild(status);
            }

            status.innerHTML = `<i class="fas fa-robot fa-spin" style="color:var(--accent)"></i> 
                <b style="color:white; margin-left:8px;">IA: Fallo detectado</b><br>
                <div style="color:#94a3b8; font-size:0.75rem; margin-top:5px;">Analizando y reestructurando UI...</div>`;

            status.style.display = 'block';

            // 2. Simular reparación
            setTimeout(() => {
                status.innerHTML = `<i class="fas fa-check-circle" style="color:var(--primary)"></i> 
                    <b style="color:white; margin-left:8px;">IA: Solucionado</b><br>
                    <div style="color:#94a3b8; font-size:0.75rem; margin-top:5px;">El sistema ha sido optimizado sin reinicio.</div>`;

                // Aquí iría lógica real de recuperación: limpiar temporizadores, re-renderizar componentes, etc.

                setTimeout(() => {
                    status.style.display = 'none';
                }, 4000);
            }, 2000);
        }

        // --- LÓGICA FORO ---
        function submitFeedback() {
            const input = document.getElementById('feedback-input');
            const txt = input.value.trim();
            if (!txt) return;

            const list = document.getElementById('feedback-list');
            const div = document.createElement('div');
            div.style.fontSize = '0.75rem';
            div.style.color = '#e6edf3';
            div.style.borderBottom = '1px dashed #333';
            div.style.paddingBottom = '5px';
            div.style.marginBottom = '5px';
            div.innerHTML = `<b style="color:var(--primary)">Tu Taller:</b> ${txt}`;

            list.insertBefore(div, list.firstChild);
            input.value = "";

            // Simular respuesta rápida
            setTimeout(() => {
                const resp = document.createElement('div');
                resp.style.fontSize = '0.75rem';
                resp.style.color = '#94a3b8';
                resp.innerHTML = `<b style="color:var(--gold)">IA Soporte:</b> Recibido. Gracias por tu aporte.`;
                list.insertBefore(resp, list.children[1]);
            }, 1000);
        }

        // =========================================
        // CAMBIAR TEMA
        // =========================================
        function toggleTheme() {
            document.body.classList.toggle('light-theme');
            const isLight = document.body.classList.contains('light-theme');
            localStorage.setItem('theme', isLight ? 'light' : 'dark');
            updateThemeIcon(isLight);
        }

        function updateThemeIcon(isLight) {
            const btn = document.getElementById('theme-toggle');
            if (btn) {
                btn.innerHTML = isLight ? '<i class="fas fa-moon"></i>' : '<i class="fas fa-sun"></i>';
                // Opcional: ajustar estilo para resaltar estado
                btn.style.background = isLight ? '#e4e6eb' : '#21262d';
                btn.style.color = isLight ? '#1c1e21' : '#fff';
            }
        }

        // Inicializar Tema
        (function () {
            const saved = localStorage.getItem('theme');
            if (saved === 'light') {
                document.body.classList.add('light-theme');
                updateThemeIcon(true);
            }
        })();

        // =========================================
        // PLANTILLA DE SIMULACIÓN (DEMO DATA)
        // =========================================
        function seedDemoData() {
            // Solo cargar si los campos están vacíos (para no borrar trabajo del usuario real)
            if (document.getElementById('matricula').value) return;

            console.log("Cargando plantilla de simulación...");

            // 1. Recepción / Ficha
            document.getElementById('matricula').value = "5678-LMN";
            document.getElementById('propietario').value = "Sofia Garcia";
            document.getElementById('telefono').value = "+34 600 123 456";

            // RX Widget
            if (document.getElementById('rx_matricula')) document.getElementById('rx_matricula').value = "5678-LMN";
            if (document.getElementById('rx_tel')) document.getElementById('rx_tel').value = "+34 600 123 456";
            if (document.getElementById('rx_km')) document.getElementById('rx_km').value = "85420";
            if (document.getElementById('rx_comb')) document.getElementById('rx_comb').value = "60";
            if (document.getElementById('rx-obs')) document.getElementById('rx-obs').value = "Vibración en volante al frenar > 100km/h.";

            // 2. Diagnóstico IA
            document.getElementById('diag-input').value = "Vibración al frenar. Posible alabeo.";
            document.getElementById('diag-result').innerHTML = `
                <div class="sec">CAUSA PROBABLE (IA 99%)</div>
                <div>Discos de freno delanteros alabeados.</div>
                <div class="sec">SOLUCIÓN SUGERIDA</div>
                <div>Sustitución de discos y pastillas eje delantero.</div>
                <div class="sec">TIEMPO / PIEZAS</div>
                <div>1.5h | Kit Discos Brembo + Pastillas</div>
            `;

            // 3. Orden de Trabajo (Presupuesto)
            document.getElementById('ot_horas').value = "2.5";
            document.getElementById('ot_precio_hora').value = "45";
            // Forzar cálculo
            otCalc();

            // 4. Facturación
            document.getElementById('vf_base').value = "392.50";
            vfCalc();
            document.getElementById('vf_status').innerHTML = `<span style="color:var(--primary);"><i class="fas fa-check"></i> EMITIDA: T-2026-001 (Simulación)</span>`;

            // 5. Foro Feedback
            const list = document.getElementById('feedback-list');
            if (list) {
                list.innerHTML = `
                <div style="font-size:0.75rem; color:#94a3b8; border-bottom:1px dashed #333; padding-bottom:5px; margin-bottom:5px;">
                    <b style="color:var(--accent)">Taller Norte:</b> Excelente la nueva función de WhatsApp.
                </div>
                <div style="font-size:0.75rem; color:#94a3b8;">
                    <b style="color:var(--gold)">AutomaDrive:</b> ¡Gracias! Seguimos mejorando.
                </div>
                ` + list.innerHTML;
            }
        }

    </script>
</body>

</html>